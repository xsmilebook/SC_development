# 会话记录（2026-01-30）

## 目标
- 在现有框架中新增两时间点纵向 multilevel（random intercept + random slope）模型，用 `lme4::lmer()` 检验 cognition/pfactor 是否调制 within-person SC change。
- time 定义为距基线年数（`time = age - baseline_age`，baseline=0，随访≈2）。
- cognition 使用 baseline 值并填充 follow-up；pfactor 保持 time-varying（与现有脚本逻辑一致）。
- 给出基于 within-person change 与认知关系的分析方案与 figure（以 `totalstrength` 为例）。

## 主要新增
- `gamfunction/lmminteraction.R`：
  - 提供 `lmm.time.predict.covariateinteraction()`，按边拟合模型 `SC ~ time + time*int_var + sex + mean_fd + (1 + time | subID)`。
  - 内部基于 `age - baseline_age` 计算 `time`（baseline 默认识别 `eventname` 中包含 `base` 的记录；否则回退到该被试最小 age）。
  - 默认用 `pbkrtest::KRmodcomp(full, null)` 对 `time:int_var` 做模型比较检验（可通过环境变量切换为 parametric bootstrap）。
  - 由于两时间点 + `(1+time|subID)` 会触发 `lme4` 的 “nobs <= nRE” 检查，函数内将该检查设为 `ignore` 以允许拟合（常见 `boundary (singular) fit` 警告）。
- 新增复现入口脚本（ABCD）：
  - cognition：`development_script/5th_cognition/run_abcd_withinperson_lmm_cognition_fluid_uncorrected.R`
  - pfactor：`development_script/6th_pfactor/run_abcd_withinperson_lmm_pfactor_general.R`
- 新增容器 sbatch（由用户提交）：
  - cognition：`sbatch/run_abcd_withinperson_lmm_cognition_fluid_uncorrected_container.sbatch`
  - pfactor：`sbatch/run_abcd_withinperson_lmm_pfactor_general_container.sbatch`

## 输出与 Figure
- edge 级结果表（含 `beta_time:int_var`、p 值、FDR 等）写入：
  - `outputs/results/5th_cognition/abcd/withinperson_lmm/`
  - `outputs/results/6th_pfactor/abcd/withinperson_lmm/`
- cognition figure（示例：within-person `totalstrength` change vs baseline cognition，控制 `sex + mean_fd` 的残差散点）写入：
  - `outputs/figures/5th_cognition/abcd/withinperson_lmm/delta_totalstrength_vs_nihtbx_fluidcomp_uncorrected_base_residualized.{pdf,tiff}`
- S-A deciles figure（10 组，decile 内对连接 change rate 取平均；先将每条连接强度除以 `plotdatasum` 的初始 `fit` 得到“归一化连接强度比率”，再计算变化率）：
  - `outputs/figures/5th_cognition/abcd/withinperson_lmm/delta_SC_decile{01..10}_vs_nihtbx_fluidcomp_uncorrected_base_residualized.{pdf,tiff}`
  - log 中输出每个 decile 的 Pearson r 与 p 值（`cor.test(cognition_base, delta_res)`）

## 输入数据说明
- cognition LMM：
  - 纵向 SC（两时间点）输入：`outputs/results/combat_gam/abcd/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam_age_sex_meanfd.rds`
  - baseline cognition 来源（提取 baseline 后按 `subID` 合并到纵向 SC）：`outputs/results/combat_gam/abcd/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam_cognition.rds`
- pfactor LMM 默认使用 Nonlinear-ComBat-GAM 的 pfactor 变体输出：
  - `outputs/results/combat_gam/abcd/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam_pfactor.rds`

## 运行方式（用户在集群上提交）
- cognition（默认 KR；全量 78 edges）：
  - `sbatch sbatch/run_abcd_withinperson_lmm_cognition_fluid_uncorrected_container.sbatch`
- pfactor（默认 KR；全量 78 edges）：
  - `sbatch sbatch/run_abcd_withinperson_lmm_pfactor_general_container.sbatch`
- 调试常用参数（两者通用）：
  - `N_EDGES=5`（先跑少量边）
  - `PB_METHOD=KR`（默认）或 `PB_METHOD=PB` + `PB_NSIM=1000`
