# 会话记录（2026-01-28）

## 目标
- 修复 HCP-D（Yeo7/Yeo17/TractSeg，ComBat-GAM）发育模型容器日志中缺少“相关系数与 p 值”等具体数值的问题。

## 现象
- 日志示例：`outputs/logs/hcpd_devmodel_yeo_tractseg_combatgam_CV75_container_13714776.log`
- S4 阶段因 `SCrank_correlation_summary.csv` 已存在触发“存在即跳过”，日志仅提示跳过（例如 `S4 summary exists; skipping...`），但未输出 Spearman 相关系数与 p 值，导致无法直接从日志快速核对结果。

## 修改
- 在以下脚本中补充“即使跳过重算也打印数值”的逻辑：
  - `development_script/2nd_fitdevelopmentalmodel/V_Yeo_network/V4th_correlationTo_SArank_Yeo_sumSCinvnode_HCPD_combatgam.R`
  - `development_script/2nd_fitdevelopmentalmodel/V_TractSeg/S4th_correlationTo_SArank_SA12sumSCinvnode_HCPD_TractSeg_combatgam.R`
  - `development_script/2nd_fitdevelopmentalmodel/S4th_correlationTo_SArank_SA12sumSCinvnode_ChineseCohort_combatgam.R`
- 行为：
  - 若 `SCrank_correlation_summary.csv` 已存在：读取该 CSV 并在日志中逐项打印 `r.spearman` 与 `p.spearman`。
  - 若需要重算（`--force=1` 或 summary 不存在）：写出 CSV 后同样打印上述数值。

## 复现与验证（集群/容器环境）
- 重新运行对应容器 sbatch 后，在日志中应出现类似输出：
  - `[INFO] SCrank Spearman summary (ds.resolution=...)`
  - `[INFO]  partialRsq: r=..., p=...`（以及其他变量）

## 追加：统一 ABCD/HCP-D 2nd 发育模型绘图风格
- 目标：将 ABCD 与 HCP-D（SA12，ComBat-GAM）2nd 发育模型输出的图像风格对齐到 `outputs/figures/2nd_fitdevelopmentalmodel/hcpd/yeo` 下的 HCP-D Yeo7 图（尺寸、配色、主题、线宽/点大小等），便于跨数据集对照。
- 修改脚本：
  - `development_script/2nd_fitdevelopmentalmodel/S3rd_visualizationfitSCcurves_SA12sumSCinvnode_HCPD.R`
  - `development_script/2nd_fitdevelopmentalmodel/S3rd_visualizationfitSCcurves_SA12sumSCinvnode_ABCD_combatgam.R`
  - `development_script/2nd_fitdevelopmentalmodel/S4th_correlationTo_SArank_SA12sumSCinvnode_HCPD.R`
  - `development_script/2nd_fitdevelopmentalmodel/S4th_correlationTo_SArank_SA12sumSCinvnode_ABCD_combatgam.R`

## 追加：sbatch 默认强制重绘 S3/S4
- 背景：绘图开销相对较低，但“存在即跳过”会导致旧风格图片长期残留；同时用“关键图缺失→补图”的逻辑会让风格更新不触发。
- 修改：在以下 sbatch 中，对 S3/S4 固定传入 `--force=1`（每次提交都会重绘图像）：
  - `sbatch/run_hcpd_devmodel_combatgam_CV75.sbatch`
  - `sbatch/run_hcpd_devmodel_combatgam_CV75_container.sbatch`
  - `sbatch/run_hcpd_devmodel_combatgam_CV75_yeo_tractseg_container.sbatch`
  - `sbatch/run_abcd_devmodel_combatgam_CV75_container.sbatch`

## 追加：HCP-D（SA12）协变量敏感性分析（SES/ICV）
- 目标：在 HCP-D SA12 ComBat-GAM 数据上，分别加入 SES（`income.adj`）与 ICV（`ICV`）作为额外协变量，得到两套可复现结果（S1–S4）。
- 关键约束：
  - S3/S4 每次强制重绘（`--force=1`），避免旧图残留；
  - 不生成 svg，统一输出 `tiff + pdf`；
  - S4 在日志中打印各指标与 S-A rank 的 Spearman 相关系数与 p 值。
- 脚本（基于 `development_script/2nd_fitdevelopmentalmodel/V_Covariates` 目录）：
  - S1：`development_script/2nd_fitdevelopmentalmodel/V_Covariates/V1st_fitgammodels_SA_ds_sumSCinvnode_HCPD_covariates.R`
  - S2：`development_script/2nd_fitdevelopmentalmodel/V_Covariates/V2nd_calculatederivative_HCPD_covariates.R`
  - S3：`development_script/2nd_fitdevelopmentalmodel/V_Covariates/V3rd_visualizationfitSCcurves_totalstrength_ICV_sumSCinvnode_HCPD.R`（文件名保留历史命名，但实际通过 `--cov_tag` 支持 SES/ICV 两版）
  - S4：`development_script/2nd_fitdevelopmentalmodel/V_Covariates/V4th_correlationTo_SArank_control_covariates_sumSCinvnode_HCPD.R`
- 一键提交（用户在集群执行）：`sbatch sbatch/run_hcpd_devmodel_combatgam_CV75_covariates_ses_icv_container.sbatch`

## 追加：HCP-D（SA12）4th_changerate_SAcorr 协变量敏感性分析（SES/ICV）
- 目标：基于 covariates 版本的 posterior derivatives，计算“change rate vs S-A rank”的年龄分辨 Spearman rho，并输出 alignment 曲线与 flip-age 分布（图像为 `tiff+pdf`，日志输出 `[RESULT]` 关键数值）。
- 脚本：
  - `development_script/4th_changerate_SAcorr/V_Covariates/V1st_SAcorr_alongAge_HCPD_add_covariates.R`
- 一键提交（用户在集群执行）：`sbatch sbatch/run_hcpd_changerate_sacorr_combatgam_CV75_covariates_ses_icv_container.sbatch`

## 追加：S2/S4 自动回填缺失 covariate
- 背景：部分 SA12 ComBat-GAM 输入 RDS 可能缺少 `income.adj` 或 `ICV` 列（或存在 NA），会影响 covariate 版本的复现一致性。
- 处理：在 covariate 管线的 S2/S4 脚本中，当检测到缺列/NA 时，自动从 `demopath/HCPD_demo_behav.csv` 按 `subID` 回填，并将 backfilled 版本保存到对应的 `outputs/intermediate/2nd_fitdevelopmentalmodel/hcpd/covariates/{SES,ICV}/combat_gam/CV75/` 目录，日志会输出回填前后的缺失计数。

## 追加：修复 covariates 容器作业全边失败（Not enough non-NA）
- 现象：`outputs/logs/hcpd_devmodel_covariates_ses_icv_CV75_container_13715070.log` 中 S1 报 `Error: All GAM fits failed`，且大量边级 warning 为 `Not enough (non-NA) data to do anything meaningful`。
- 根因：回填 `income.adj/ICV` 时 `subID` 未对齐（例如存在 `sub-` 前缀/格式差异），导致 covariate 回填后仍为大面积 NA，进而每条边拟合可用样本不足。
- 修复：S1/S2/S4 的回填逻辑对 `subID` 做标准化（去除 `sub-`/`sub_` 前缀、trim 空白）后再 join；S1 进一步对 `age/sex/mean_fd/covariate` 做 complete-case 过滤并在日志输出可用样本数，避免“全边失败且难定位”。
