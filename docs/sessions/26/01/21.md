# 会话记录（2026-01-21）

## 目标
- 修复 Singularity 容器构建中频繁出现的 `knitr` 安装失败（`xfun` API 不匹配）问题，并将修复记录到文档。

## 现象与定位
- 构建日志（示例：`outputs/logs/containers/build_scdev_r41_13702864.log`）在安装 `knitr` 阶段报错：
  - `Error: object ‘attr’ is not exported by 'namespace:xfun'`
- 同一构建过程中可见 `xfun_0.56` 被从 CRAN 当前版本拉取并安装，导致与 `knitr_1.43` 不兼容。

## 修复
- `containers/scdevelopment_r41.def`：
  - 将 `xfun==0.52` 与 `knitr==1.43` 提前安装，并在末尾再次“锁定”以防依赖链覆盖。
  - 在 `remotes::install_version()` 中显式限制 `dependencies=Depends/Imports/LinkingTo`，避免自动安装 `Suggests` 引入版本漂移。
- 文档：
  - `docs/workflow.md` 增补该常见构建报错与处理策略。
  - `PROGRESS.md` 记录本次修复。

## 追加：修复容器作业中 `rbind` 报错（边级模型拟合失败导致输出列不一致）
- 作业日志：`outputs/logs/hcpd_devmodel_combatgam_CV75_container_13702893.log`
- 现象：`Error in match.names(clabs, names(xi)) : names do not match previous names`（调用栈 `do.call -> rbind -> match.names`）。
- 根因：`development_script/2nd_fitdevelopmentalmodel/S1st_fitgammodels_SA_ds_sumSCinvnode_HCPD.R` 中对每条边的 `gam.fit.smooth()` 结果直接 `do.call(rbind, ...)`；当某些边拟合失败返回 `NULL`/error 对象时，`rbind` 会因列名不一致崩溃。
- 修复：对边级拟合增加 `tryCatch`，仅保留“统计结果 + 模型对象”都成功的边；使用 `dplyr::bind_rows()` 合并结果并将失败边写入 `outputs/intermediate/2nd_fitdevelopmentalmodel/hcpd/combat_gam/CV75/failed_edges_*.txt` 便于追踪。

## 追加：修复 S3 可视化脚本在“部分边缺失”情况下崩溃
- 作业日志：`outputs/logs/hcpd_devmodel_combatgam_CV75_container_13702906.log`
- 现象：
  - `Warning: all scheduled cores encountered errors in user code`
  - `Error in plotdatasum[[i]][, -14] : incorrect number of dimensions`
- 根因：`S3rd_visualizationfitSCcurves_SA12sumSCinvnode_HCPD.R` 假设 `gammodelsum` 与 `gamresults` 均为 78 条边，且 `plotdatasum[[i]]` 一定是 data.frame；当 S1 因拟合失败跳过部分边时，S3 仍按 `seq_len(elementnum)` 遍历并用固定列号 `-14` 删列，导致空对象/列数变化时崩溃。
- 修复：
  - S3 改为按 `min(length(gammodelsum), nrow(gamresults))` 迭代，并对 `plotdata_generate()` 增加 `tryCatch` 跳过失败边。
  - 删列改为按名称删除响应列（与 `parcel` 同名），避免依赖固定列位置。
  - S-A rank 改为按 `parcel` 映射（`SC.1_h`…`SC.78_h`）而非按行号硬编码。

## 追加：修复 `plotdatasum_scale_TRUE_SA12.rds` 中出现 `try-error`（predict(se.fit=TRUE) 失败）
- 现象：`plotdatasum_scale_TRUE_SA12.rds` 中部分元素为 `try-error`，典型报错为：
  - `lm object does not have a proper 'qr' component. Rank zero or should not have used lm(.., qr=FALSE).`
- 解释：`gamfunction/plotdata_generate.R` 会调用 `predict(model, pred, se.fit=TRUE)` 以生成置信区间；少数模型在该调用路径下会触发 `qr` 相关错误（通常与底层 `lm` 的 QR 分解缺失/秩为 0 有关），从而导致拟合值生成失败并被 `mclapply` 写入 `try-error`。
- 修复：`gamfunction/plotdata_generate.R` 对 `predict(..., se.fit=TRUE)` 增加容错；失败时回退到 `se.fit=FALSE`（仅保留 `fit`，CI 列为 NA），确保 `plotdatasum_scale_TRUE_SA12.rds` 始终为可用的 data.frame 列表并避免后续绘图崩溃。
- 进一步加固：
  - 强制使用 `mgcv::predict.gam()`（避免 `predict()` 泛型在多包环境下误派发）。
  - 构造 `newdata` 时显式对齐拟合数据的变量类型与 factor level，降低 `se.fit=TRUE` 路径下的异常概率。

## 追加：S1-S4 默认“存在即跳过”（逐步跳过）
- 需求：避免重复计算，且可从失败步骤继续跑。
- 实现：HCP-D 的 S1/S2/S3/S4 Rscript 版本均增加 `--force=1` 开关；默认（未设置/为 0）时按输出文件是否存在逐步跳过：
  - S1：若 `gamresults*.rds` 与 `gammodel*.rds` 已存在则跳过拟合；其余中间产物按文件存在判断跳过。
  - S2：若 `derivative.df*.rds` 已存在则跳过；posterior 同理。
  - S3：若 `plotdatasum_scale_TRUE_SA12.rds` 与关键图文件已存在则跳过。
  - S4：若 `SCrank_correlation_summary.csv` 已存在则跳过。

## 追加：用 conda 环境 QC 检查 gammodel/gamresults
- 需求：在 conda R 环境下验证当前生成的 `gammodel`/`gamresults` 是否存在结构或预测层面的隐患（并屏蔽用户/系统 R 包路径）。
- 实现：
  - QC 脚本：`development_script/2nd_fitdevelopmentalmodel/QC_check_gam_outputs_HCPD.R`
  - sbatch：`sbatch/qc_hcpd_devmodel_outputs_condenv.sbatch`
  - QC 输出：`outputs/results/2nd_fitdevelopmentalmodel/hcpd/combat_gam/CV75/qc/`（summary + edge-level 明细）

## 追加：修复 ggsave 保存 SVG 失败（缺少 svglite）
- 现象：`ggsave()` 报 `The package "svglite" is required to save as SVG.`
- 处理：HCP-D 的 S3/S4 脚本将 `.svg` 输出改为 `.pdf`（同时保留 `.tiff`），避免引入额外系统依赖。

## 追加：修复 S3 在缺少 `significant.derivative_fdr` 列时崩溃
- 作业日志：`outputs/logs/hcpd_devmodel_combatgam_CV75_container_13702941.log`
- 现象：`replacement has 0 rows, data has 78000`（尝试将 `numeric(0)` 赋值给 data.frame 列）。
- 根因：S2 导出的 `derivative.df*.rds` 默认仅包含 `derivative/significant/significant.derivative` 等列，不包含 `significant.derivative_fdr`；S3 直接执行 `as.numeric(derivative$significant.derivative_fdr)` 会得到 `numeric(0)` 并导致赋值崩溃。
- 修复：`development_script/2nd_fitdevelopmentalmodel/S3rd_visualizationfitSCcurves_SA12sumSCinvnode_HCPD.R` 在读入 `derivative.df` 后自动补齐 `significant.derivative_fdr`：
  - 若存在 `significance_pvalue_fdr`：按其为 TRUE 的行保留 `derivative`，否则置 NA；
  - 否则若存在 `significant`：按其为 TRUE 的行保留 `derivative`，否则置 NA；
  - 否则回退使用 `significant.derivative`（兼容旧导数输出）。

## 追加：修复 S4 相关性散点图在 `psych::corr.test()` 返回标量时崩溃
- 作业日志：`outputs/logs/hcpd_devmodel_combatgam_CV75_container_13702944.log`
- 现象：`Error in ct$r[[1, 2]] : incorrect number of subscripts`（调用栈 `plot_one_scatter`）。
- 根因：`psych::corr.test(x, y)` 在 `x/y` 为向量时，`ct$r`/`ct$p` 可能是标量或 `1x1`，而非 `2x2` 矩阵；脚本固定用 `ct$r[[1,2]]` 取值导致越界。
- 修复：`development_script/2nd_fitdevelopmentalmodel/S4th_correlationTo_SArank_SA12sumSCinvnode_HCPD.R` 增加 `extract_corr()` 兼容两种返回结构（标量与矩阵），统一抽取 Spearman `r/p` 用于标题显示。

## 追加：sbatch 自动回填缺失图片（避免 “summary/哨兵存在但图片为空”）
- 现象：S3/S4 默认“存在即跳过”，但其 skip 判定依赖少数哨兵文件（S3）或仅依赖 summary CSV（S4）；当历史运行在绘图阶段失败/中断时，会出现“脚本显示跳过、但图片目录为空”的状态。
- 处理：`sbatch/run_hcpd_devmodel_combatgam_CV75_container.sbatch` 增加缺失图片检测：
  - 若缺少 `.../SA12_decile_sumSCinvnode_fit/devcurve_SCrank_fit.Z_SCtype10.tiff`，则对 S3 自动传入 `--force=1`；
  - 若缺少 `.../correlation_sumSCinvnode_SCrank/meanpartialRsq_SCrankcorr_n12.tiff`，则对 S4 自动传入 `--force=1`。
  - 可用 `FORCE_S3`/`FORCE_S4` 环境变量覆盖该行为。

## 追加：修复 S3 在保存图片时因 ggplot guide 计算异常崩溃
- 作业日志：`outputs/logs/hcpd_devmodel_combatgam_CV75_container_13702954.log`
- 现象：`Error in Ops.data.frame(guide_loc, panel_loc) : '==' only defined for equally-sized data frames`（调用栈 `ggsave -> plot_table.ggplot -> add_guides`）。
- 处理：在 `development_script/2nd_fitdevelopmentalmodel/S3rd_visualizationfitSCcurves_SA12sumSCinvnode_HCPD.R` 中对所有绘图使用的 scale 显式设置 `guide=\"none\"`（`scale_color_distiller`/`scale_fill_gradient2`/`scale_color_gradient2`），避免 ggplot2 在无图例需求时仍进入 guide 布局分支导致的异常。

## 追加：合并 NIH Toolbox total cognition（age-corrected）并新增 ABCD 纵向 ComBat-GAM 变体
- 人口学表合并：
  - 将 `demopath/nc_y_nihtb.csv` 的 `nihtbx_totalcomp_agecorrected` 按 `src_subject_id + eventname` 左连接合并到 `demopath/DemodfScreenFinal.csv`（插入在 `nihtbx_totalcomp_uncorrected` 之后）。
  - 注：该列在 `nc_y_nihtb.csv` 中对 key 唯一（无重复/冲突），合并为一对一。
- 新增纵向 Nonlinear-ComBat-GAM：
  - CBCL total problems（参考 pfactor 的做法，不做 baseline-only）：`combat_gam/scripts/run_abcd_nonlinear_combat_gam_cbcl.R` + sbatch `combat_gam/sbatch/abcd_combat_gam_cbcl.sbatch`。
  - NIH Toolbox total cognition（age-corrected，参考 cognition 的做法，baseline-only）：`combat_gam/scripts/run_abcd_nonlinear_combat_gam_comp_agecorrected_baseline.R` + sbatch `combat_gam/sbatch/abcd_combat_gam_comp_agecorrected_baseline.sbatch`。

## 追加：可复用经验汇总写入 workflow
- 已将本次排错与工程化经验整理补充到 `docs/workflow.md` 的“可复用经验（本次会话）”，后续同类问题优先按该清单排查与固化。

## 追加：修复 ABCD Nonlinear-ComBat-GAM 作业缺少表型列导致的失败
- 作业日志：`outputs/logs/combat_gam/combat_abcd_gam_comp_agecorrected_baseline_13703009.log`
- 现象：`Error: Missing columns: nihtbx_totalcomp_agecorrected`（输入 RDS 缺少表型列）。
- 根因：ABCD 的 `input_rds`（`SCdata_*.merge.rds`）主要包含 SC 与基础协变量，部分表型（如 `nihtbx_totalcomp_agecorrected`、`cbcl_scr_syn_totprob_r`）并未写入该 RDS。
- 修复：
  - `combat_gam/scripts/run_abcd_nonlinear_combat_gam_comp_agecorrected_baseline.R` 与 `combat_gam/scripts/run_abcd_nonlinear_combat_gam_cbcl.R` 在检测到表型列缺失时，按 `scanID` 从 `demopath/DemodfScreenFinal.csv` 自动回填（并对回填失败给出明确报错），以保持 sbatch 入口不变。

## 追加：修复 HCP-D 发育模型容器作业保存图片时的 `add_guides` 崩溃（ggplot2/patchwork 版本）
- 作业日志：`outputs/logs/hcpd_devmodel_combatgam_CV75_container_13702955.log`
- 现象：`Error in Ops.data.frame(guide_loc, panel_loc) : '==' only defined for equally-sized data frames`（`ggsave -> add_guides`）。
- 根因：容器内固定的 `ggplot2 4.x` 在当前绘图组合（含 `patchwork`/无图例场景）下会触发布局比较失败。
- 修复：
  - `containers/scdevelopment_r41.def` 将 `ggplot2` 固定到稳定版本 `3.5.0`，并将 `patchwork` 更新到 `1.3.0`。
  - 需要在集群重新构建镜像并用 `SIF_PATH` 指向新镜像复跑。

## 下一步（需要在集群执行）
- 重新提交构建：`sbatch sbatch/build_scdevelopment_r41_container.sbatch`（计算节点需代理与 `module load singularity/3.7.0`）。该脚本会生成一个新的镜像 `outputs/containers/scdevelopment_r41_<tag>.sif`（默认 `<tag>=SLURM_JOB_ID`，可用 `SIF_TAG` 自定义），不会覆盖现有镜像。
- 构建成功后建议快速验证：在容器内 `library(knitr); library(xfun);` 并检查 `gamm4/lme4/ragg/nloptr` 可加载。
