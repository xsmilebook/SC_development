# 2026-01-20 会话记录

## 目标
- 修复 HCP-D 与 Chinese Cohort 的 ComBat-GAM（neuroHarmonize）平滑项设置不一致问题。

## 变更
- `combat_gam/scripts/run_combat_gam_neuroharmonize.py`：`mgcv::smoothCon()` 的年龄平滑项改为 `s(age, k=3, bs="tp", fx=TRUE)`，以与既定 GAMM 设定一致（固定平滑自由度）。

## 影响范围
- 仅影响通过 `combat_gam/scripts/run_combat_gam_neuroharmonize.py` 运行的 HCP-D/Chinese ComBat-GAM；ABCD Nonlinear-ComBat-GAM 不受影响。

## 追加：ComBat 效应可视化更新
- 移除方差分解图中基于所有子集的 Shapley R² 计算（`shapley_r2`/`subset_bits`）。
- 新增 drop-one Delta R² 逻辑：先拟合全模型 `R²_full`，再逐一移除变量拟合 `R²_reduced`，计算 `ΔR² = R²_full - R²_reduced`。
- 重新生成 ABCD/HCP-D/Chinese（含 CBCL total raw）对应的变量解释量图。
- 新增集群绘图 sbatch：`combat_gam/sbatch/plot_abcd_variance_decomposition.sbatch`、`combat_gam/sbatch/plot_hcpd_chinese_variance_decomposition.sbatch`。
