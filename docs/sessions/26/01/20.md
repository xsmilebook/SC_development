# 2026-01-20 会话记录

## 目标
- 修复 HCP-D 与 Chinese Cohort 的 ComBat-GAM（neuroHarmonize）平滑项设置不一致问题。

## 变更
- `combat_gam/scripts/run_combat_gam_neuroharmonize.py`：`mgcv::smoothCon()` 的年龄平滑项改为 `s(age, k=3, bs="tp", fx=TRUE)`，以与既定 GAMM 设定一致（固定平滑自由度）。

## 影响范围
- 仅影响通过 `combat_gam/scripts/run_combat_gam_neuroharmonize.py` 运行的 HCP-D/Chinese ComBat-GAM；ABCD Nonlinear-ComBat-GAM 不受影响。

## 追加：ComBat 效应可视化更新
- 移除方差分解图中基于所有子集的 Shapley R² 计算（`shapley_r2`/`subset_bits`）。
- 将变量解释量改为序列（sequential）R²：按 `age→sex→mean_fd→表型→site` 顺序逐步加入变量，计算每一步的 `R²_k - R²_{k-1}`。
- 重新生成 ABCD/HCP-D/Chinese（含 CBCL total raw）对应的变量解释量图。
- 新增集群绘图 sbatch：`combat_gam/sbatch/plot_abcd_variance_decomposition.sbatch`、`combat_gam/sbatch/plot_hcpd_chinese_variance_decomposition.sbatch`。
- Chinese Cohort 的 raw 默认输入固定为 `.../SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.merge_new.rds`。
- ABCD 的方差分解（`combat_gam/scripts/plot_abcd_variance_decomposition.R`）改为使用 `gamm4` 直接拟合纵向数据；若单条边拟合失败则跳过该边。

## 追加：neuroHarmonize 原生 smooth_terms 提交脚本
- 新增 `combat_gam/scripts/run_combat_gam_neuroharmonize_native.py`：直接使用 neuroHarmonize `harmonizationLearn(..., smooth_terms=[age], smooth_fx=...)`。
- 新增 sbatch：
  - `combat_gam/sbatch/hcpd_combat_gam_native.sbatch`
  - `combat_gam/sbatch/chinese_combat_gam_native.sbatch`
- 修复 statsmodels spline 参数限制：默认 `smooth_df=4`（满足 `smooth_df >= smooth_degree + 1`，其中 `smooth_degree=3`）。

## 追加：ABCD baseline age+sex+meanFD（Reviewer2 Q5）
- 新增 ABCD baseline 的 `age+sex+meanFD` 纵向 ComBat 脚本（不保护 cognition）：`combat_gam/scripts/run_abcd_nonlinear_combat_gam_baseline_age_sex_meanfd.R`。
- 对应提交脚本：`combat_gam/sbatch/abcd_combat_gam_baseline_age_sex_meanfd.sbatch`，默认输出 `*combatgam_age_sex_meanfd_baseline.rds`。

## sbatch 分区与绘图并行
- 统一 sbatch 分区为 `q_fat_c,q_fat,q_fat_l`。
- 方差分解绘图 sbatch 的 `--cpus-per-task` 调整为 72，以匹配脚本内 `mclapply` 的并行能力（仍建议限制 BLAS 线程为 1）。

## 追加：修复 ABCD 方差分解绘图报错（gamm4 random intercept 不可用）
- 报错表现：大量边在 `gamm4(..., random = ~(1|subID))` 下触发 “grouping factor levels must be < number of observations”，导致所有边都被跳过，最终 `raw_results` 为空并在 `arrange(total_r2)` 处崩溃。
- 修复策略：当某条边的数据不满足随机截距拟合条件（例如 baseline-only 时每个 `subID` 仅 1 次观测，或 `nlevels(subID) >= nrow(df)`）时，自动回退为 `mgcv::gam`（不含 random intercept）以保证图可生成；同时对“全为空”的结果做空表兜底与安全退出。
- 涉及脚本：`combat_gam/scripts/plot_abcd_variance_decomposition.R`、`development_script/1st_dataclean/S4th_plot_abcd_variance_decomp_cbcl.R`。

## 小结
- CBCL 关联分析：修复环境/依赖导致的启动失败，并将绘图输出统一写入项目内目录（详见 2026-01-19 会话与相关提交记录）。
- ComBat-GAM（HCP-D/Chinese）：补齐 neuroHarmonize 平滑项设定与原生 `smooth_terms` 的提交脚本；明确 `smooth_df` 的 statsmodels 约束以避免运行时错误。
- ComBat 效应可视化：将变量解释量从全子集方法改为序列（sequential）R²，并对 ABCD 采用 `gamm4` 拟合纵向数据（失败边跳过），同时通过 72 核并行降低绘图耗时风险。

## 追加：HCP-D 发育模型（基于 ComBat-GAM 输出）
- 背景：`development_script/2nd_fitdevelopmentalmodel` 的历史 HCP-D 脚本存在硬编码绝对路径，且 S3/S4 仅提供 Rmd；本次按项目约束改为“输入/输出均在当前仓库路径内”。
- 默认输入：`outputs/results/combat_gam/hcpd/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`。
- 脚本调整：
  - `development_script/2nd_fitdevelopmentalmodel/S1st_fitgammodels_SA_ds_sumSCinvnode_HCPD.R`、`development_script/2nd_fitdevelopmentalmodel/S2nd_calculatederivative_HCPD.R`：改为使用项目内 `outputs/` 路径并支持 `--input_rds/--cvthr/--n_edges` 等参数。
  - 新增 Rscript：`development_script/2nd_fitdevelopmentalmodel/S3rd_visualizationfitSCcurves_SA12sumSCinvnode_HCPD.R`、`development_script/2nd_fitdevelopmentalmodel/S4th_correlationTo_SArank_SA12sumSCinvnode_HCPD.R`（对应原 Rmd）。
- 提交脚本：新增 `sbatch/run_hcpd_devmodel_combatgam_CV75.sbatch`，默认使用 `scdevelopment_r41` 环境并将日志写入 `outputs/logs/`。
- 产物目录：
  - intermediates：`outputs/intermediate/2nd_fitdevelopmentalmodel/hcpd/combat_gam/CV75/`
  - results：`outputs/results/2nd_fitdevelopmentalmodel/hcpd/combat_gam/CV75/`
  - figures：`outputs/figures/2nd_fitdevelopmentalmodel/hcpd/combat_gam/CV75/`

## 追加：修复 sbatch 报错（R 包缺失）并补充依赖检查
- 报错日志：`outputs/logs/hcpd_devmodel_combatgam_CV75_13702772.log`，原因是 `gratia` 载入失败（缺失 `mvnfast`），且 `patchwork`/`ecostats` 在 `scdevelopment_r41` 环境中也未安装。
- 处理：
  - 在 `scdevelopment_r41` 环境中补装：`mvnfast`、`patchwork`、`gratia==0.8.1`（R 4.1 兼容版本）、`ecostats`（及其依赖）。
  - 更新 `sbatch/run_hcpd_devmodel_combatgam_CV75.sbatch`：显式设置 `R_LIBS_SITE` 并在正式运行前打印 `.libPaths()`、检查关键 R 包是否齐全（确保屏蔽系统 R 库后仍可运行）。

## 追加：修复 S1 GAM 拟合报错（gratia 列名不兼容 / anovaPB 并行报错）
- 现象 1：`gamfunction/gamsmooth.R` 中对 `gratia::derivatives()` 返回列名的假设与 `gratia==0.8.1` 不一致（`lower/upper/derivative` vs `.lower_ci/.upper_ci/.derivative`），导致 `.lower_ci` 不存在而报错。
- 现象 2：历史 `ecostats::anovaPB()` 在本集群环境下若使用默认并行（`ncpus=NULL`）会触发 SOCK cluster 序列化报错（例如 `nbinom2 not found`）。
- 修复：
  - `gamfunction/gamsmooth.R`、`gamfunction/gamderivatives.R`：兼容 `gratia` 不同版本的列名，统一映射到脚本内部使用的字段。
  - `gamfunction/gamsmooth.R`：保留 `ecostats::anovaPB()`（parametric bootstrap），但强制 `ncpus=1`，避免嵌套并行与 SOCK 序列化问题；外层仍通过 `mclapply` 在 edge 维度并行。

## 追加：频繁出现的 GLIBC_2.xx not found（conda R 包在计算节点不可用）
- 报错日志：`outputs/logs/hcpd_devmodel_combatgam_CV75_13702777.log`。
- 现象：在计算节点加载 conda 环境中的 `tidyverse/gratia/scales/patchwork/mvnfast/reshape/ecostats` 等包时报：
  - `.../cli.so: GLIBC_2.32 not found`
  - `.../farver.so: GLIBC_2.29 not found`
  - `.../Rcpp.so: GLIBC_2.33 not found`
- 解释：登录节点与计算节点的 GLIBC 版本不一致，导致在登录节点安装/更新过的 R 包（即使安装在 conda 环境目录）在计算节点无法加载。
- 修复：在 sbatch 内将 `R_LIBS_USER` 指向项目内目录 `outputs/r_libs/scdevelopment_r41/`，并对缺失或载入失败的包执行 `install.packages(..., lib=R_LIBS_USER)`，使其在计算节点上编译安装以匹配该节点 GLIBC；同时保留 `R_LIBS_SITE=${CONDA_PREFIX}/lib/R/library` 作为回退路径。
- 代码位置：`sbatch/run_hcpd_devmodel_combatgam_CV75.sbatch` 已实现“运行前自动补装依赖”并打印 `.libPaths()`/版本信息，避免该类错误再次阻断正式计算。

## 追加：计算节点无法访问 CRAN（cannot open URL .../PACKAGES）
- 现象：`install.packages()` 在计算节点下载 `https://cloud.r-project.org/src/contrib/PACKAGES` 失败，进而误报 “package is not available for this version of R”，导致依赖自动补装流程中断。
- 处理：在登录节点预先下载所需包及依赖的源码 tar.gz，并在项目内生成离线 CRAN 仓库索引：
  - repo：`outputs/r_cran_repo/src/contrib/`（包含 `*.tar.gz` 与 `PACKAGES.gz`）
  - sbatch 侧：将 `options(repos=c(CRAN="file://.../outputs/r_cran_repo"))`，在计算节点离线安装到 `outputs/r_libs/scdevelopment_r41/`。
- 状态：`sbatch/run_hcpd_devmodel_combatgam_CV75.sbatch` 已切换为默认使用离线 repo；并在缺少 `PACKAGES.gz` 时给出明确错误提示。

## 追加：容器方案（Singularity/3.7.0）避免反复依赖问题
- 背景：近期 HCP-D 发育模型在计算节点频繁出现两类错误：
  - `GLIBC_2.xx not found`（例如 `cli.so`、`farver.so`、`Rcpp.so`），由登录/计算节点 GLIBC 不一致引起；
  - 计算节点无法访问 CRAN（`cannot open URL .../PACKAGES`），导致 `install.packages()` 补装失败并误报 “package is not available for this version of R”。
- 解决：新增项目专用 Singularity 容器（R 4.1.3，固定 mgcv/nlme/ecostats/gratia 等关键版本），在容器内预装主要 R 依赖，减少节点差异影响。
- 文件：
  - 定义：`containers/scdevelopment_r41.def`
  - 构建 sbatch：`sbatch/build_scdevelopment_r41_container.sbatch`（输出 `outputs/containers/scdevelopment_r41.sif`）
  - 运行 sbatch：`sbatch/run_hcpd_devmodel_combatgam_CV75_container.sbatch`

## 追加：修复容器定义脚本转义报错
- 现象：`containers/scdevelopment_r41.def` 中 `%post` 的 `Rscript -e ' ... \\'` 多行转义在远端构建环境中触发 `unexpected end of line in " \\"`，导致 build 失败并出现 `build image size <= 0`。
- 修复：将 R 包安装逻辑改为 heredoc 写入 `/tmp/install_r_pkgs.R` 再执行，避免 shell 引号/反斜杠转义问题。

## 追加：修复容器内 `gamm4` 不可用（CRAN 版本要求 R>=4.4）
- 现象：构建日志提示 `package ‘gamm4’ is not available for this version of R`，原因是 CRAN 当前 `gamm4` 版本声明依赖 R>=4.4。
- 修复：在容器定义中固定安装 CRAN Archive 版本 `gamm4==0.2-6`（兼容 R 4.1.x）。

## 追加：补齐容器内常用 R 包集合（基于脚本静态扫描）
- 根据 `development_script/` 与 `gamfunction/` 中 `library(...)`/`pkg::fun` 的静态扫描结果，容器在原有基础上额外安装常用包以减少运行时缺包风险：
  - 绘图/可视化：`ggcorrplot`、`geomtextpath`、`paletteer`、`pals`、`visreg`
  - 统计/混合模型：`lme4`、`pbkrtest`
  - IO/工具：`gdata`、`rjson`
  - 兼容旧脚本：`reshape2`
  - 报告：`knitr`
  - 汇总：`tableone`

## 追加：容器“最大稳定性”版本固定策略
- 为减少远端构建时 CRAN 版本漂移导致的行为变化/构建失败，容器对脚本直接依赖的包以及关键工具链包执行显式版本固定（`remotes::install_version(..., upgrade="never")`）。
- 额外固定一组“工具链/编译型依赖”包（如 `Rcpp/cli/farver/stringi/rlang/vctrs`），用于稳定 tidyverse 与绘图链条的编译与加载行为。

## 追加：修复容器内 R 包编译依赖缺失（cmake/libwebp-dev 等）
- 现象：构建容器时部分包编译失败（如 `nloptr` 提示 `CMAKE NOT FOUND`、`ragg` 提示缺少 `libwebp`、进而影响 `lme4/gamm4` 等依赖链）。
- 修复：
  - `containers/scdevelopment_r41.def`：apt 依赖增加 `cmake`、`libwebp-dev`（ragg 所需）。
  - R 包依赖链补齐并固定版本：增加 `RcppEigen==0.3.3.9.3`、`minqa==1.2.5`、`nloptr==2.0.3`，确保 `lme4==1.1-33` 与 `gamm4==0.2-6` 可编译安装。

## 追加：容器构建常见问题（fakeroot/subuid 与代理）
- 报错：`FATAL: could not use fakeroot: no mapping entry found in /etc/subuid for <user>`：集群未为该用户配置 fakeroot/subuid，`singularity build --fakeroot` 不可用。
  - 处理：构建脚本已移除 `--fakeroot`；若仍无法以普通用户构建，需管理员支持（setuid build 或配置 fakeroot/subuid）。
- 报错：`FATAL: You must be the root user, however you can use --remote or --fakeroot ...`：集群禁止普通用户本地 build；需使用 `--remote` 或联系管理员配置可用的 fakeroot/subuid。
  - 处理：构建脚本已切换为 `singularity build --remote`（可选通过 `SINGULARITY_REMOTE_TOKEN` 在 sbatch 中登录 remote）。
- 网络：仅计算节点可联网且需代理；构建脚本已在 sbatch 内导出 `http_proxy/https_proxy/...` 并同步到 `SINGULARITYENV_*`。
