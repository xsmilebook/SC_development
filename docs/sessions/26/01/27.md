# 2026-01-27

## 修复：p-factor 交互曲线年龄范围异常（重复按月份缩放）

### 现象
- `development_script/6th_pfactor/run_abcd_pfactor_effect_continuous_S1.R` 的交互曲线图中年龄范围偏小（例如显示约 8–11 而不是预期的 9–13）。

### 根因（推断）
- 部分输入 SCdata 的 `age` 列可能已被转换为“年”，但在历史流程中又被再次按“月→年”缩放，导致 `age` 实际为 `years/12`。
- 脚本原有的 `age_to_years()` 仅能区分“月”(>24) 与“年”(<=24)，无法识别 `years/12` 的情况。

### 修复
- 在 `development_script/6th_pfactor/run_abcd_pfactor_effect_continuous_S1.R` 的 `age_to_years()` 中增加启发式检测：当 `max(age)<=2` 且乘以 12 后落在合理年龄范围内时，将 `age` 乘回 12。
- 另外，为避免旧版缓存导致修复不生效，脚本会自动检测 `plotdata_high90_low10_*_develop_*.rds` 缓存的年龄范围；若发现缓存 `age` 最大值 <=2 但当前数据 `age` 最大值 >5，则自动丢弃并重算缓存。

## 新增：Chinese Cohort（ComBat-GAM）2nd 发育模型一键提交流程

### 需求
- 在 `development_script/2nd_fitdevelopmentalmodel` 基础上，使用 ComBat-GAM 输出
  `outputs/results/combat_gam/chinese/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
  作为输入，跑通发育模型（S1–S4），并提供可复用的 `sbatch` 脚本（参考现有 HCP-D 实现）。

### 实现
- 新增 Chinese Cohort（ComBat-GAM）Rscript 入口（均为 project-root 相对路径；输出写入 `outputs/`）：
  - `development_script/2nd_fitdevelopmentalmodel/S1st_fitgammodels_SA_ds_sumSCinvnode_ChineseCohort_combatgam.R`
  - `development_script/2nd_fitdevelopmentalmodel/S2nd_calculatederivative_ChineseCohort_combatgam.R`
  - `development_script/2nd_fitdevelopmentalmodel/S3rd_visualizationfitSCcurves_SA12sumSCinvnode_ChineseCohort_combatgam.R`
  - `development_script/2nd_fitdevelopmentalmodel/S4th_correlationTo_SArank_SA12sumSCinvnode_ChineseCohort_combatgam.R`
- 提供容器版一键提交脚本（默认 50 核，多分区）：`sbatch/run_chinese_devmodel_combatgam_CV75_container.sbatch`
  - 默认输入：`outputs/results/combat_gam/chinese/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
  - 默认欧氏距离：`wd/interdataFolder_HCPD/average_EuclideanDistance_12.csv`（与数据集无关；可用 `EUCLID_CSV=...` 覆盖）
  - 支持小样本测试：`N_EDGES=10`；跳过 posterior：`SKIP_POSTERIOR=1`
  - 若检测到关键图缺失，脚本会自动对 S3/S4 启用 `--force=1` 以回补图片（可用 `FORCE_S3/FORCE_S4` 覆盖）

### 文档更新
- 在 `docs/workflow.md` 增加 Chinese devmodel 的可复现入口与输出目录约定。

### 补充：图像输出与原始脚本一致
- 调整 `S3rd_visualizationfitSCcurves_SA12sumSCinvnode_ChineseCohort_combatgam.R` 与 `S4th_correlationTo_SArank_SA12sumSCinvnode_ChineseCohort_combatgam.R`：
  - S3：默认输出与原始 Rmd 一致（3 张图，各自 tiff+svg）；示例边图改为可选（`--make_examples=1`）。
  - S4：默认输出与原始 Rmd 一致（`meanderv2_c` tiff；`meanderv2_c_control_distance` tiff+svg）；matrix graph 仍为可选（`MAKE_MATRIX_GRAPHS=1`）。

## 新增：HCP-D（Yeo7/Yeo17/TractSeg major-bundle）ComBat-GAM 一键提交

### 输入（外部绝对路径）
- `/ibmgpfs/cuizaixu_lab/xuxiaoyu/SC_development/interdataFolder_HCPD/SCdata_Yeo7_CV75_sumSCinvnode.sum.msmtcsd.merge.rds`
- `/ibmgpfs/cuizaixu_lab/xuxiaoyu/SC_development/interdataFolder_HCPD/SCdata_Yeo17_CV75_sumSCinvnode.sum.msmtcsd.merge.rds`
- `/ibmgpfs/cuizaixu_lab/xuxiaoyu/SC_development/interdataFolder_HCPD/SCdata_SA12_CV75_sumSCinvnode.TractSeg.merge.rds`

### 提交脚本
- `combat_gam/sbatch/hcpd_combat_gam_yeo_tractseg_CV75.sbatch`
  - 默认输出到 `outputs/results/combat_gam/hcpd/`：
    - `SCdata_Yeo7_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
    - `SCdata_Yeo17_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
    - `SCdata_SA12_CV75_sumSCinvnode.TractSeg.combatgam.rds`
  - 小样本 smoke test：`TEST_N=200 sbatch combat_gam/sbatch/hcpd_combat_gam_yeo_tractseg_CV75.sbatch`

## 新增：HCP-D（Yeo7/Yeo17/TractSeg）发育模型（2nd_fitdevelopmentalmodel）容器一键提交

### 目标
- 使用 Yeo7/Yeo17/TractSeg 各自的 `outputs/results/combat_gam/hcpd/*combatgam.rds` 作为输入，
  复现 2nd 发育模型（S1–S4）并生成与原脚本一致的 figure 命名与数量。

### 实现
- 新增可运行（project-root 相对路径）的脚本（基于 `V_Yeo_network`/`V_TractSeg` 逻辑，修复硬编码路径与函数签名不一致）：
  - Yeo（HCP-D）：
    - `development_script/2nd_fitdevelopmentalmodel/V_Yeo_network/V1st_fitgammodels_Yeo_sumSCinvnode_HCPD_combatgam.R`
    - `development_script/2nd_fitdevelopmentalmodel/V_Yeo_network/V2nd_calculatederivative_HCPD_combatgam.R`
    - `development_script/2nd_fitdevelopmentalmodel/V_Yeo_network/V3rd_visualizationfitSCcurves_Yeo_sumSCinvnode_HCPD_combatgam.R`
    - `development_script/2nd_fitdevelopmentalmodel/V_Yeo_network/V4th_correlationTo_SArank_Yeo_sumSCinvnode_HCPD_combatgam.R`
  - TractSeg（HCP-D）：
    - `development_script/2nd_fitdevelopmentalmodel/V_TractSeg/S1st_fitgammodels_SA_ds_sumSCinvnode_HCPD_TractSeg_combatgam.R`
    - `development_script/2nd_fitdevelopmentalmodel/V_TractSeg/S2nd_calculatederivative_HCPD_TractSeg_combatgam.R`
    - `development_script/2nd_fitdevelopmentalmodel/V_TractSeg/S3rd_visualizationfitSCcurves_SA12sumSCinvnode_HCPD_TractSeg_combatgam.R`
    - `development_script/2nd_fitdevelopmentalmodel/V_TractSeg/S4th_correlationTo_SArank_SA12sumSCinvnode_HCPD_TractSeg_combatgam.R`
- 新增容器一键提交脚本：`sbatch/run_hcpd_devmodel_combatgam_CV75_yeo_tractseg_container.sbatch`
  - 依次跑：Yeo7 → Yeo17 → TractSeg（均支持 `N_EDGES`/`SKIP_POSTERIOR`）
  - 默认会生成 matrix graphs（与原脚本一致）；可用 `MAKE_MATRIX_GRAPHS_YEO=0` 或 `MAKE_MATRIX_GRAPHS_TRACTSEG=0` 关闭
  - 若检测到关键图缺失，脚本会自动对对应步骤启用 `--force=1` 回补图片（可用 `FORCE_*` 覆盖）

## 修复：ComBat-GAM sbatch 读取外部 RDS 失败（pyreadr 不兼容）

### 现象
- `combat_gam/scripts/run_combat_gam_neuroharmonize.py` 使用 `pyreadr.read_r()` 读取
  `/ibmgpfs/cuizaixu_lab/xuxiaoyu/SC_development/interdataFolder_HCPD/*.rds` 时失败：
  `pyreadr.custom_errors.LibrdataError: Invalid file, or file has unsupported features`

### 根因
- 部分 `.rds` 可能由较新版本 R 保存，包含 `librdata/pyreadr` 不支持的序列化特性；因此并非环境/容器问题，而是读取后端不兼容。

### 修复
- `run_combat_gam_neuroharmonize.py` 增加自动回退：当 `pyreadr` 读取失败时，改用 `rpy2` 调用 R 的 `readRDS()` 并转换为 pandas DataFrame（速度更慢但兼容性更好）。
