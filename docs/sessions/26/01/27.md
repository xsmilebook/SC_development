# 2026-01-27

## 修复：p-factor 交互曲线年龄范围异常（重复按月份缩放）

### 现象
- `development_script/6th_pfactor/run_abcd_pfactor_effect_continuous_S1.R` 的交互曲线图中年龄范围偏小（例如显示约 8–11 而不是预期的 9–13）。

### 根因（推断）
- 部分输入 SCdata 的 `age` 列可能已被转换为“年”，但在历史流程中又被再次按“月→年”缩放，导致 `age` 实际为 `years/12`。
- 脚本原有的 `age_to_years()` 仅能区分“月”(>24) 与“年”(<=24)，无法识别 `years/12` 的情况。

### 修复
- 在 `development_script/6th_pfactor/run_abcd_pfactor_effect_continuous_S1.R` 的 `age_to_years()` 中增加启发式检测：当 `max(age)<=2` 且乘以 12 后落在合理年龄范围内时，将 `age` 乘回 12。
- 另外，为避免旧版缓存导致修复不生效，脚本会自动检测 `plotdata_high90_low10_*_develop_*.rds` 缓存的年龄范围；若发现缓存 `age` 最大值 <=2 但当前数据 `age` 最大值 >5，则自动丢弃并重算缓存。

## 新增：Chinese Cohort（ComBat-GAM）2nd 发育模型一键提交流程

### 需求
- 在 `development_script/2nd_fitdevelopmentalmodel` 基础上，使用 ComBat-GAM 输出
  `outputs/results/combat_gam/chinese/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
  作为输入，跑通发育模型（S1–S4），并提供可复用的 `sbatch` 脚本（参考现有 HCP-D 实现）。

### 实现
- 新增 Chinese Cohort（ComBat-GAM）Rscript 入口（均为 project-root 相对路径；输出写入 `outputs/`）：
  - `development_script/2nd_fitdevelopmentalmodel/S1st_fitgammodels_SA_ds_sumSCinvnode_ChineseCohort_combatgam.R`
  - `development_script/2nd_fitdevelopmentalmodel/S2nd_calculatederivative_ChineseCohort_combatgam.R`
  - `development_script/2nd_fitdevelopmentalmodel/S3rd_visualizationfitSCcurves_SA12sumSCinvnode_ChineseCohort_combatgam.R`
  - `development_script/2nd_fitdevelopmentalmodel/S4th_correlationTo_SArank_SA12sumSCinvnode_ChineseCohort_combatgam.R`
- 提供容器版一键提交脚本（默认 50 核，多分区）：`sbatch/run_chinese_devmodel_combatgam_CV75_container.sbatch`
  - 默认输入：`outputs/results/combat_gam/chinese/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
  - 默认欧氏距离：`wd/interdataFolder_HCPD/average_EuclideanDistance_12.csv`（与数据集无关；可用 `EUCLID_CSV=...` 覆盖）
  - 支持小样本测试：`N_EDGES=10`；跳过 posterior：`SKIP_POSTERIOR=1`
  - 若检测到关键图缺失，脚本会自动对 S3/S4 启用 `--force=1` 以回补图片（可用 `FORCE_S3/FORCE_S4` 覆盖）

### 文档更新
- 在 `docs/workflow.md` 增加 Chinese devmodel 的可复现入口与输出目录约定。
