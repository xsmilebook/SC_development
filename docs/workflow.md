# 可复现流程

## 目标与范围
- 目标：在现有数据与脚本基础上，根据审稿意见修订文章，并开展新的关联分析。
- 当前计划：CBCL total raw 与 SC 的相关（含 S-A axis 相关）；harmonize/ComBat 方法按评论意见更新。
- 约束：不在此文档中自行决策新的 harmonize/ComBat 方案；仅记录已存在流程与待更新项。

## 数据与路径
- 新的数据输入与结果输出分别放在 `data/` 与 `outputs/`。
- 允许直接使用绝对路径以兼容既有数据与集群环境。
- 若使用绝对路径，请在此文档或会话记录中注明数据版本、来源与路径。
- 所有新生成的数据与结果必须保存在当前项目路径下。
- `wd/` 作为历史结果与中间产物目录，保持不动。
- 本仓库不使用 `configs/` 或 `src/` 结构，避免将现有脚本迁移导致路径失效。
- `combat_gam/` 用于集中存放 ComBat-GAM 与纵向 ComBat 相关代码及其依赖。
- ComBat 运行日志统一写入 `outputs/logs/combat_gam/`，输出结果保存到 `outputs/results/combat_gam/`。
- ABCD 表型回填：`demopath/DemodfScreenFinal.csv` 用于按 `scanID` 回填部分表型列；其中 `nihtbx_fluidcomp_agecorrected` 与 `nihtbx_fluidcomp_fc` 来自 `demopath/nc_y_nihtb.csv` 并按 `src_subject_id + eventname` 合并（脚本：`development_script/1st_dataclean/S0th_merge_nihtbx_fluidcomp_fc_ABCD.R`）。

## 容器运行（Singularity/Apptainer）
- 背景：部分计算节点无法加载在登录节点安装/更新过的 conda R 包（GLIBC 版本不匹配），且计算节点常无法访问 CRAN，导致运行时反复报错（`GLIBC_2.xx not found` / `cannot open URL .../PACKAGES`）。
- 解决：使用项目内 Singularity 容器（R 4.1.3，固定 mgcv/nlme/ecostats/gratia 等关键版本），避免节点差异导致的依赖不一致。
- 构建（集群）：`sbatch sbatch/build_scdevelopment_r41_container.sbatch`，默认生成新镜像 `outputs/containers/scdevelopment_r41_<tag>.sif`（避免覆盖正在使用的旧镜像）；可用 `SIF_TAG` 自定义 `<tag>`。
- 运行（集群）：`sbatch sbatch/run_hcpd_devmodel_combatgam_CV75_container.sbatch`（与非容器版参数一致，支持 `N_EDGES`/`SKIP_POSTERIOR`）；如需指定新镜像，传入 `SIF_PATH=/.../scdevelopment_r41_<tag>.sif`。
  - 绘图策略：S3/S4 默认始终使用 `--force=1` 强制重新绘图（绘图成本较低，且可避免“存在即跳过”导致的旧风格图片未刷新）。
- HCP-D（SA12，ComBat-GAM）协变量敏感性分析（SES 与 ICV 两个版本）：
  - sbatch：`sbatch sbatch/run_hcpd_devmodel_combatgam_CV75_covariates_ses_icv_container.sbatch`
  - 输入：默认使用 `outputs/results/combat_gam/hcpd/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`；若缺少 `income.adj/ICV` 列，会从 `demopath/HCPD_demo_behav.csv` 按 `subID` 回填。
- 输出：写入 `outputs/{intermediate,results,figures}/2nd_fitdevelopmentalmodel/hcpd/covariates/{SES,ICV}/combat_gam/CV75/`（S3 输出 `tiff+pdf`；S4 输出 `tiff+pdf`，Windows 下额外生成 `svg` 需 `svglite`；Windows 默认仅绘图不写 summary，交互环境默认不跑 matrix graphs；日志中打印 Spearman r 与 p）。
- 定义文件：`containers/scdevelopment_r41.def`（可按需扩展依赖，但应尽量保持版本稳定；为降低 HPC/容器环境的系统依赖，默认流程不依赖 `svglite`，图像输出推荐使用 `tiff + pdf`）。
  - 常见构建报错：`could not use fakeroot: no mapping entry found in /etc/subuid for <user>`：说明集群未为该用户配置 fakeroot/subuid。当前构建脚本不使用 `--fakeroot`；若仍失败需联系管理员开启 setuid build 或提供可用的 fakeroot 配置。
  - 常见构建报错：`You must be the root user ... use --remote or --fakeroot`：说明本地 build 需要 root/setuid；当前构建脚本使用 `singularity build --remote`。
  - 常见构建报错：`Error: object ‘attr’ is not exported by 'namespace:xfun'`（`knitr` lazy-load 失败）：通常是 `xfun` API 随 CRAN 更新发生漂移。处理：在容器定义中固定 `xfun==0.52` 与 `knitr==1.43`，并确保安装时不自动拉取 `Suggests` 依赖导致的版本覆盖。
  - 网络：计算节点联网需代理；构建脚本已内置 `http(s)_proxy` 等环境变量导出。

## 年龄分辨的 S-A 对齐分析（4th_changerate_SAcorr，基于 ComBat-GAM）
- 目标：在 1,000 个年龄点上，计算“posterior derivative（SC change rate） vs S-A axis rank”的 Spearman rho，并从 1,000 个 posterior draws 得到中位数与 95% CI；同时在日志中输出 flip-age（rho≈0 的年龄）及其 CI 等关键数值。
- 前置：需要 `development_script/2nd_fitdevelopmentalmodel` 生成的 `derivative.df*` 与 `derivative.posterior.df*`（sbatch 脚本会在缺失时自动补跑上游步骤；可用 `FORCE=1` 强制重算）。
- 提交命令（用户在集群上执行）：
  - HCP-D：`sbatch sbatch/run_hcpd_changerate_sacorr_combatgam_CV75_container.sbatch`（包含 4th 的 S1+S2 完整流程：对齐曲线 + flip-age 分组 GAM）
  - HCP-D（SA7）：`sbatch sbatch/run_hcpd_changerate_sacorr_combatgam_CV75_SA7_container.sbatch`（输出写入 `CV75_SA7/`；默认不做欧氏距离 control）
  - HCP-D（SA17）：`sbatch sbatch/run_hcpd_changerate_sacorr_combatgam_CV75_SA17_container.sbatch`（输出写入 `CV75_SA17/`；默认不做欧氏距离 control）
  - HCP-D（SA axis multiply，SAmult）：`sbatch sbatch/run_hcpd_changerate_sacorr_combatgam_CV75_SAmult_container.sbatch`（输出写入 `CV75_SAmult/`；S-A rank 采用 `x*y`）
  - HCP-D（SES/ICV 协变量敏感性分析，SA12）：`sbatch sbatch/run_hcpd_changerate_sacorr_combatgam_CV75_covariates_ses_icv_container.sbatch`（输出 `tiff+pdf`，日志输出 `[RESULT]` 关键数值）
  - HCP-D（Yeo7/Yeo17/TractSeg major-bundle）：`sbatch sbatch/run_hcpd_changerate_sacorr_combatgam_CV75_yeo_tractseg_container.sbatch`（依次跑 Yeo7→Yeo17→TractSeg；同样会在 log 中输出 `[RESULT]` 数值）
  - Chinese Cohort：`sbatch sbatch/run_chinese_changerate_sacorr_combatgam_CV75_container.sbatch`（输出 `tiff+pdf`；日志输出 `[RESULT]` 的 flip-age、rho 以及分组相关 r/p）
  - ABCD：`sbatch sbatch/run_abcd_changerate_sacorr_combatgam_CV75_container.sbatch`
- 常用参数（环境变量）：
  - `CVTHR=75`（默认 75）
  - `N_DRAWS=1000`（默认 1000；小样本可设为 50/100）
  - `N_EDGES=78`（可选；小样本测试可设为 5/10）
  - `FORCE=0/1`
  - ABCD 输入可覆盖：`INPUT_RDS=/ibmgpfs/.../SCdata_...combatgam_age_sex_meanfd.rds`
- 输出位置：
  - 结果表：
    - SA12：`outputs/results/4th_changerate_SAcorr/{hcpd,abcd}/combat_gam/CV75/`
    - HCP-D Yeo/TractSeg：`outputs/results/4th_changerate_SAcorr/hcpd/{yeo/Yeo7,yeo/Yeo17,tractseg}/combat_gam/CV75/`
  - 图片：
    - SA12：`outputs/figures/4th_changerate_SAcorr/{hcpd,abcd}/combat_gam/CV75/Alignment_development/`
    - HCP-D Yeo/TractSeg：`outputs/figures/4th_changerate_SAcorr/hcpd/{yeo/Yeo7,yeo/Yeo17,tractseg}/combat_gam/CV75/Alignment_development/`
    - 以上默认输出 `.tiff + .pdf`；Windows 环境额外输出 `.svg`（需 `svglite`）
  - Windows 本地绘图：S1 脚本默认只读取已有 `alignment_*` 结果绘图，不在 Windows 端重算相关矩阵；如缺少结果文件会直接报错。
  - HCP-D（SA12，ComBat-GAM）S1 额外输出（control-distance 版本）：
    - 思路：在每个年龄点上先对 change rate 按边的欧氏距离做线性残差化（`derivative ~ Edistance`），再与 S-A rank 做 Spearman 相关。
    - 结果表：`alignment_*_control_distance.csv*`（与主版本同目录）
    - 图片：`*_control_distance.{tiff,pdf}`（与主版本同目录）
    - 欧氏距离默认读取：`wd/interdataFolder_HCPD/average_EuclideanDistance_12.csv`（可用 `Rscript ... --euclid_csv=/path/to.csv` 覆盖）
  - 日志：`outputs/logs/4th_changerate_SAcorr_{dataset}_CV75_<jobid>.log`（包含 `[RESULT]` 行的具体数值）

## ComBat-GAM 运行约定
- 小型测试可直接运行 `combat_gam/scripts/*.sh`；正式任务必须使用 `combat_gam/sbatch/*.sbatch` 提交到 `q_fat_c`。
- ComBat-GAM 使用项目专用环境：`/GPFS/cuizaixu_lab_permanent/xuhaoshu/miniconda3/envs/scdevelopment`。
- HCP-D/Chinese 推荐使用 neuroHarmonize 原生 `smooth_terms`（GAM）实现：`combat_gam/scripts/run_combat_gam_neuroharmonize_native.py`（支持 `smooth_fx` 固定平滑或 k-fold 选择）。
- HCP-D 派生表（如 Yeo/TractSeg）若缺少 `site` 列，可在 ComBat-GAM 时从 SA12 merge 表按 `subID` 回填：`/ibmgpfs/cuizaixu_lab/xuxiaoyu/SC_development/interdataFolder_HCPD/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.merge.rds`（`combat_gam/scripts/run_combat_gam_neuroharmonize.py` 支持 `--batch-source-rds`）。
- 运行相关依赖应安装在 `scdevelopment` 环境；若包依赖冲突需建立独立虚拟环境，并在此处补充说明。
- Reviewer2（Q5）补充：ABCD baseline 的 `age+sex+meanFD` 纵向 ComBat（不保护 cognition）可用 `combat_gam/sbatch/abcd_combat_gam_baseline_age_sex_meanfd.sbatch` 提交，输出 `*combatgam_age_sex_meanfd_baseline.rds`。
- ABCD 纵向 Nonlinear-ComBat-GAM（新增变体）：
  - CBCL total problems：`sbatch combat_gam/sbatch/abcd_combat_gam_cbcl.sbatch`，输出 `*combatgam_cbcl.rds`（协变量列：`cbcl_scr_syn_totprob_r`；不做 baseline-only）。
  - NIH Toolbox fluid cognition（age-corrected，baseline-only）：`sbatch combat_gam/sbatch/abcd_combat_gam_comp_agecorrected_baseline.sbatch`，输出 `*combatgam_comp_agecorrected_baseline.rds`（协变量列：`nihtbx_fluidcomp_agecorrected`；仅保留 baseline 与 cognition 方案一致）。
  - NIH Toolbox fluid cognition（fully-corrected/fc，baseline-only）：`sbatch combat_gam/sbatch/abcd_combat_gam_fluidcomp_fc_baseline.sbatch`，输出 `*combatgam_fluidcomp_fc_baseline.rds`（协变量列：`nihtbx_fluidcomp_fc`；仅保留 baseline 与 cognition 方案一致）。
  - 注：ABCD 的 `input_rds` 常仅包含 SC 与基础协变量；若缺少上述表型列，脚本会按 `scanID` 从 `demopath/DemodfScreenFinal.csv` 自动回填后再运行（回填失败会给出明确报错）。
- ABCD 的 Nonlinear-ComBat-GAM 支持并行：`nlongcombat` 使用 `mclapply`，核数由 `SLURM_CPUS_PER_TASK` 控制；未设置时默认单核。

### 非容器作业的 GLIBC 报错处理
- 典型报错：`/lib64/libc.so.6: version 'GLIBC_2.32' not found (required by .../cli.so)`（常由 `dplyr/cli` 等包触发）。
- 根因：在登录节点编译/安装的 R 包会链接登录节点的 GLIBC；当计算节点 GLIBC 更旧时，作业在 `dyn.load()` 阶段直接失败。
- 推荐做法（不使用容器时）：
  - 优先使用已在计算节点验证可用的 conda 环境（本项目默认 `scdevelopment`）。
  - 若必须使用 `scdevelopment_r41` 一类新环境，请在计算节点上重新安装触发问题的 R 包（从源码编译），或在同一 GLIBC 版本的节点上完成安装后再提交作业。
  - `combat_gam/sbatch/plot_*_variance_decomposition.sbatch` 已默认使用 `CONDA_ENV=scdevelopment`（可通过 `CONDA_ENV=scdevelopment_r41` 覆盖）；当出现 GLIBC 报错时请不要在计算节点继续使用会触发报错的环境。
- 结构连接 R² 方差分解图（Raw vs ComBat）由 `combat_gam/scripts/plot_abcd_variance_decomposition.R` 生成，输出在 `outputs/figures/combat_gam/`，包含：
  - `abcd_variance_decomp_base`（age+sex+meanFD）
  - `abcd_variance_decomp_cognition_fluid_uncorrected`（含 fluid cognition uncorrected；`nihtbx_fluidcomp_uncorrected`，Raw 侧按 baseline-only 过滤）
  - `abcd_variance_decomp_pfactor`（含 p-factor）
  - `abcd_variance_decomp_cbcl_totprob`（含 CBCL total problems；读取 `cbcl_scr_syn_totprob_r`，必要时从 `demopath/DemodfScreenFinal.csv` 按 `scanID` 回填）
  - `abcd_variance_decomp_cognition_fluidcomp_agecorrected`（含 NIH Toolbox fluid cognition age-corrected；读取 `nihtbx_fluidcomp_agecorrected`，必要时从 `demopath/DemodfScreenFinal.csv` 按 `scanID` 回填；Raw 侧按 baseline-only 过滤）
  - `abcd_variance_decomp_cognition_fluidcomp_fc`（含 NIH Toolbox fluid cognition fully-corrected/fc；读取 `nihtbx_fluidcomp_fc`，必要时从 `demopath/DemodfScreenFinal.csv` 按 `scanID` 回填；Raw 侧按 baseline-only 过滤）
- 方差分解的变量解释量采用 **序列（sequential）R²**：按 `age → sex → mean_fd → (cognition/pfactor/cbcl 等) → site` 顺序逐步加入变量，每一步的解释量为 `R²_k - R²_{k-1}`（不再计算所有子集 Shapley）。
- 集群绘图可直接提交：
  - `combat_gam/sbatch/plot_abcd_variance_decomposition.sbatch`
  - `combat_gam/sbatch/plot_hcpd_chinese_variance_decomposition.sbatch`

## HCP-D/Chinese ComBat-GAM（neuroHarmonize 原生 smooth_terms）
- HCP-D 提交：`sbatch combat_gam/sbatch/hcpd_combat_gam_native.sbatch`
- Chinese 提交：`sbatch combat_gam/sbatch/chinese_combat_gam_native.sbatch`
- HCP-D（Yeo7/Yeo17/TractSeg major-bundle，CV75，输入来自 `/ibmgpfs/cuizaixu_lab/xuxiaoyu/SC_development/interdataFolder_HCPD`）：`sbatch combat_gam/sbatch/hcpd_combat_gam_yeo_tractseg_CV75.sbatch`
- 输出默认写入：
  - `outputs/results/combat_gam/hcpd/*combatgam_native.rds`
  - `outputs/results/combat_gam/chinese/*combatgam_native.rds`
- 注：statsmodels GAM 的 B-spline 要求 `smooth_df >= smooth_degree + 1`；当前脚本默认使用 `smooth_degree=3` 且 `smooth_df=4`。
- CBCL total raw 的 Raw vs ComBat 方差分解图由 `development_script/1st_dataclean/S4th_plot_abcd_variance_decomp_cbcl.R` 生成，输出为 `abcd_variance_decomp_cbcl_totalraw`；ComBat 输出默认写入 `outputs/results/combat_cbcl/`。
- CBCL total raw 的 siteID R² 明细与汇总由 `development_script/1st_dataclean/S5th_export_cbcl_site_r2_summary.R` 导出，输出为 `outputs/results/combat_cbcl/cbcl_site_r2_raw_vs_combat.csv` 与 `cbcl_site_r2_summary.csv`。
- HCPD 与 Chinese Cohort 的 Raw vs ComBat 方差分解图由 `combat_gam/scripts/plot_hcpd_chinese_variance_decomposition.R` 生成，输出为：
  - `hcpd_variance_decomp`
  - `chinese_variance_decomp`
  - 注：Chinese Cohort 中 `study`（siteID）与年龄分布强烈不均衡时，ComBat-GAM 只能在保留年龄效应的前提下校正批次差异，部分 residual site 效应可能仍存在。

## 分析流程（对应现有脚本）
1) 数据整理与 SC 强度提取（`development_script/1st_dataclean`）

## 发育模型脚本的“存在即跳过”约定（HCP-D/ABCD/Chinese）
- 为避免重复计算（尤其是 S1 拟合与 S2 posterior derivative），`development_script/2nd_fitdevelopmentalmodel` 的 Rscript 版本默认采用 **存在即跳过**（HCP-D/ABCD/Chinese 的 ComBat-GAM 可复现脚本均遵循该约定）：
  - S1：当 `gamresults*.rds` 与 `gammodel*.rds` 对应输出已存在时跳过重新拟合；其他中间文件（如 `plotdatasum.df_*`、`SCdata.diw_*`、`*_scale_TRUE.rds`）同理按文件存在判断跳过。
  - S2：当 `derivative.df*.rds`（以及 posterior 的 `derivative.posterior*.rds`）存在时跳过。
  - S3：当 `plotdatasum_scale_TRUE_SA12.rds` 与关键图（`devcurve_Rsq_fit.ratio.tiff`、`devcurve_meanderv2_fit.Z.tiff`）存在时跳过。
  - S4：当 `SCrank_correlation_summary.csv` 存在时跳过重算（但会在日志中读取并打印 Spearman 相关系数与 p 值，便于检查）。
- 强制重跑：为任一步脚本增加 `--force=1`（例如：`Rscript .../S3rd_visualizationfitSCcurves_SA12sumSCinvnode_HCPD.R --force=1`）。
- 注：HCP-D devmodel 的 S4 若 summary 已存在（`--force=0`），但散点图缺失，将自动补画 `correlation_sumSCinvnode_SCrank_*`（不会重算 summary；SA7/SA17/SAmult 等 tag 版本同样适用）。

## HCP-D 发育模型输出 QC（conda 环境）
- 目的：在 **conda R 环境** 下检查已生成的 `gamresults/gammodel`（raw+scaled）是否一致、是否为 `mgcv::gam` 对象、以及 `mgcv::predict.gam()` 是否可用（含 `se.fit` 路径）。
- 脚本：`development_script/2nd_fitdevelopmentalmodel/QC_check_gam_outputs_HCPD.R`
- 集群提交：`sbatch sbatch/qc_hcpd_devmodel_outputs_condenv.sbatch`（日志：`outputs/logs/qc_hcpd_gamout_%j.log`）
- 输出：`outputs/results/2nd_fitdevelopmentalmodel/hcpd/combat_gam/CV75/qc/`
   - 合并数据与一致性阈值筛选。
   - 提取大尺度 SC 矩阵并生成汇总数据。
   - 进行站点/批次 harmonize（ComBat，待按评论更新）；CBCL total raw 可用 `S3rd_combat_controlsite_ABCD_CBCLtotalraw.R` 的测试参数先小样本跑通。
2) 发育模型与导数分析（`development_script/2nd_fitdevelopmentalmodel`）
   - GAM/GAMM 建模，生成拟合曲线与导数。
   - 计算与 S-A 轴的相关与可视化。
   - HCP-D（基于 ComBat-GAM 输出）的可复现运行入口：
     - 输入默认：`outputs/results/combat_gam/hcpd/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
     - sbatch：`sbatch/run_hcpd_devmodel_combatgam_CV75.sbatch`
     - SA7/SA17（使用项目内 SA7/SA17 的 ComBat-GAM 输出）：
       - 先跑 ComBat-GAM：`sbatch combat_gam/sbatch/hcpd_combat_gam_sa7_sa17_CV75.sbatch`
       - devmodel（容器版一键提交）：
         - SA7：`sbatch sbatch/run_hcpd_devmodel_combatgam_CV75_SA7_container.sbatch`
         - SA17：`sbatch sbatch/run_hcpd_devmodel_combatgam_CV75_SA17_container.sbatch`
       - 说明：为避免覆盖 SA12 的 S4 输出，SA7/SA17 的 S4 会写出 `SCrank_correlation_summary_{SA7|SA17}.csv` 并在日志打印 r/p。
     - SA axis multiply（SAmult，S-A rank 采用 `x*y`）：
       - devmodel（容器版一键提交）：`sbatch sbatch/run_hcpd_devmodel_combatgam_CV75_SAmult_container.sbatch`
       - 输出：`SCrank_correlation_summary_SAmult.csv` 与 `correlation_sumSCinvnode_SCrank_SAmult/`（不覆盖默认 SA12 版本）
     - 产物目录：
       - intermediates：`outputs/intermediate/2nd_fitdevelopmentalmodel/hcpd/combat_gam/CV75/`
       - results：`outputs/results/2nd_fitdevelopmentalmodel/hcpd/combat_gam/CV75/`
     - figures：`outputs/figures/2nd_fitdevelopmentalmodel/hcpd/combat_gam/CV75/`
     - S4 散点图输出：默认生成 `tiff+pdf`，Windows 环境下额外输出 `svg`（需要 `svglite`）；Windows 默认仅绘图（不写 summary），且在交互环境（RStudio/source）默认不跑 matrix graphs；可用 `--skip_compute_on_windows=0`/`--make_matrix_graphs=1` 覆盖。
     - HCP-D（Yeo7/Yeo17/TractSeg major-bundle，使用各自 ComBat-GAM 输出）的容器版一键提交：
       - sbatch：`sbatch/run_hcpd_devmodel_combatgam_CV75_yeo_tractseg_container.sbatch`
       - 输入（默认）：
         - `outputs/results/combat_gam/hcpd/SCdata_Yeo7_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
         - `outputs/results/combat_gam/hcpd/SCdata_Yeo17_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
         - `outputs/results/combat_gam/hcpd/SCdata_SA12_CV75_sumSCinvnode.TractSeg.combatgam.rds`
       - 产物目录：
         - intermediates：`outputs/intermediate/2nd_fitdevelopmentalmodel/hcpd/{yeo,tractseg}/**/CV75/`
         - results：`outputs/results/2nd_fitdevelopmentalmodel/hcpd/{yeo,tractseg}/**/CV75/`
     - figures：`outputs/figures/2nd_fitdevelopmentalmodel/hcpd/{yeo,tractseg}/**/CV75/`
     - Yeo/TractSeg S4 散点图：默认 `tiff+pdf`，Windows 下额外输出 `svg`（需要 `svglite`）；Windows 默认仅绘图（不写 summary）且交互环境默认不跑 matrix graphs，可用 `--skip_compute_on_windows=0`/`--make_matrix_graphs=1` 覆盖。
   - 注意：若出现 `object '.lower_ci' not found`（gratia 输出列名变动），请使用已修复的 `gamfunction/gammsmooth.R` 并重新提交对应作业。
	   - Chinese Cohort（基于 ComBat-GAM 输出）的可复现运行入口：
	     - 输入默认：`outputs/results/combat_gam/chinese/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam.rds`
	     - sbatch（容器版，72 核）：`sbatch sbatch/run_chinese_devmodel_combatgam_CV75_container.sbatch`
	     - 产物目录：
	       - intermediates：`outputs/intermediate/2nd_fitdevelopmentalmodel/chinese/combat_gam/CV75/`
	       - results：`outputs/results/2nd_fitdevelopmentalmodel/chinese/combat_gam/CV75/`
	       - figures：`outputs/figures/2nd_fitdevelopmentalmodel/chinese/combat_gam/CV75/`
	     - 图像数量与格式：S3 默认生成 3 张图（tiff+pdf）；S4 生成 2 张散点（tiff+pdf），若在 Windows 环境运行则额外输出 svg（需要 `svglite`）；如需 matrix graphs，提交时设置 `MAKE_MATRIX_GRAPHS=1`。
	     - Windows 便捷模式：S4 默认在 Windows 跳过 summary 计算，仅生成散点图；可用 `--skip_compute_on_windows=0` 关闭（或 `--force=1` 强制完整重算）。
   - ABCD（基于 ComBat-GAM 输出）的可复现运行入口：
     - 输入默认：`outputs/results/combat_gam/abcd/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam_age_sex_meanfd.rds`
     - sbatch（容器版，50 核）：`sbatch sbatch/run_abcd_devmodel_combatgam_CV75_container.sbatch`
   - 产物目录：
     - intermediates：`outputs/intermediate/2nd_fitdevelopmentalmodel/abcd/combat_gam/CV75/`
     - results：`outputs/results/2nd_fitdevelopmentalmodel/abcd/combat_gam/CV75/`
     - figures：`outputs/figures/2nd_fitdevelopmentalmodel/abcd/combat_gam/CV75/`
   - S4 散点图输出：`correlation_sumSCinvnode_SCrank/` 内默认生成 `pdf`；若在 Windows 环境运行则额外输出 `svg`（需要 `svglite`）。
   - Windows 便捷模式：S4 默认在 Windows 跳过 summary 计算，仅生成散点图；可用 `--skip_compute_on_windows=0` 关闭（或 `--force=1` 强制完整重算）。
3) S-A 轴可视化（`development_script/3rd_plotConnectionalAxis`）
4) 年龄分段与变化率分析（`development_script/4th_changerate_SAcorr`）
5) 认知与心理病理相关分析（`development_script/5th_cognition`、`development_script/6th_pfactor`）
   - CBCL total raw 关联分析脚本见 `development_script/6th_pfactor/S2nd_cbcl_totalraw_effect_continuous_ABCD.R`。
   - 小样本验证脚本见 `development_script/6th_pfactor/S2nd_cbcl_totalraw_effect_continuous_ABCD_smalltest.R`。
   - CBCL 关联分析绘图输出（t-value matrix、S-A rank 散点、分位数组轨迹）写入 `outputs/figures/cbcl_totprob/`。
   - ABCD p-factor（GENERAL；Nonlinear-ComBat-GAM 输出 `*combatgam_pfactor.rds`）S1 复现入口（连续效应 + age-by-pfactor smooth interaction）：
     - sbatch（容器版，72 核）：`sbatch sbatch/run_abcd_pfactor_effect_continuous_container.sbatch`
     - 结果：`outputs/results/6th_pfactor/abcd/pfactor/`
     - 图像（tiff + svg/pdf）：`outputs/figures/6th_pfactor/abcd/pfactor/`
     - 注：交互曲线图需要 `ABCD_PLOTDATASUM_RDS`（默认指向 `outputs/intermediate/2nd_fitdevelopmentalmodel/abcd/combat_gam/CV75/plotdatasum.df_SA12_sumSCinvnode_siteall_CV75.rds`；可在提交时覆盖）。
   - ABCD 两时间点 within-person SC change 的纵向调制检验（LMM；random intercept + random slope；`lme4::lmer`）：
     - 模型（每条边/或 `totalstrength`）：`SC ~ time + time*int_var + sex + mean_fd + (1 + time | subID)`
       - `time`：距基线年数（`time = age - baseline_age`；基线=0，随访≈2；baseline 由 `eventname` 中包含 `base` 的记录识别，否则回退到该被试最小 age）。
   - ABCD 年龄随机斜率 LMM（固定效应 + 随机效应矩阵）：
     - 脚本：`development_script/5th_cognition/run_abcd_age_lmm_random_slope_cognition_groups.R`
     - 模型（每条边）：`SC ~ age + sex + mean_fd + (1 + age || subID)`
     - 处理流程：不做额外异常值剔除；≥2 时间点筛选在脚本中完成，函数内部仅做 complete-case。
     - 建模前：每条边若出现超出均值±3SD 的观测，则剔除该被试的全部观测（按该边的 SC 值筛选）。
     - SC 归一化：建模前按 `ABCD_PLOTDATASUM_RDS` 的 `fit` 对每条边做 ratio 缩放（与 S3 交互曲线一致）。
     - 收敛检查：`lmer` 的梯度阈值调为 0.02（保持 warning 行为），用于降低轻微不收敛提示（`check.conv.grad`）。
     - 接口支持返回个体随机斜率（`return_slopes=TRUE` 时返回每个 `subID` 的随机斜率与固定斜率）。
     - 接口支持返回完整模型对象（`return_model=TRUE` 时返回 `lme4::lmer` 模型）。
     - 随机效应矩阵使用随机斜率的“平均绝对值”（random slopes 以 0 为中心，直接均值会接近 0）。
     - 输出：
       - 结果：`outputs/results/5th_cognition/abcd/age_lmm/`
       - 图像：`outputs/figures/5th_cognition/abcd/age_lmm/`
       - 模型对象：`age_lmm_random_slope_models_*_CV*.rds`（每条边一个 `lme4::lmer` 模型）
       - 个体斜率：`age_lmm_random_slope_personal_slopes_*_CV*.rds`（每条边一个 data.frame，含 fixed/random/个人斜率）
     - 记录：结果表包含 `singular` 标记（`lme4::isSingular()`）。
     - S-A 相关：固定效应（age beta）与随机斜率均值（全样本 78 edges）
     - S-A 相关：个人斜率均值（全样本 78 edges）
     - 散点图：不做 3 SD 异常值剔除。
     - 矩阵：全样本 fixed/random/personal；low10/high10 个人斜率矩阵；low10 vs high10 的 t-value 矩阵（FDR 显著标记，色标按 |value| 对称；t 检验常量/失败时置为 0）
   - ABCD p-factor 年龄随机斜率 LMM（固定效应 + 随机效应矩阵）：
     - 脚本：`development_script/6th_pfactor/run_abcd_age_lmm_random_slope_pfactor_groups.R`
     - 模型（每条边）：`SC ~ age + sex + mean_fd + (1 + age || subID)`
     - 处理流程：不做额外异常值剔除；≥2 时间点筛选在脚本中完成，函数内部仅做 complete-case。
     - 建模前：每条边若出现超出均值±3SD 的观测，则剔除该被试的全部观测（按该边的 SC 值筛选）。
     - SC 归一化：建模前按 `ABCD_PLOTDATASUM_RDS` 的 `fit` 对每条边做 ratio 缩放（与 S3 交互曲线一致）。
     - 输出：
       - 结果：`outputs/results/6th_pfactor/abcd/age_lmm/`
       - 图像：`outputs/figures/6th_pfactor/abcd/age_lmm/`
       - 模型对象：`age_lmm_random_slope_models_*_CV*.rds`（每条边一个 `lme4::lmer` 模型）
       - 个体斜率：`age_lmm_random_slope_personal_slopes_*_CV*.rds`（每条边一个 data.frame，含 fixed/random/个人斜率）
     - 记录：结果表包含 `singular` 标记（`lme4::isSingular()`）。
     - S-A 相关：固定效应（age beta）与随机斜率均值（全样本 78 edges）
     - S-A 相关：个人斜率均值（全样本 78 edges）
     - 散点图：不做 3 SD 异常值剔除。
     - 矩阵：全样本 fixed/random/personal；low10/high10 个人斜率矩阵；low10 vs high10 的 t-value 矩阵（FDR 显著标记，色标按 |value| 对称；t 检验常量/失败时置为 0）
   - 临时对比脚本（LCMM vs LMM 参数差异，单边示例）：
     - 脚本：`development_script/5th_cognition/tmp_compare_lcmm_lmm_params.R`
     - 输入：`*combatgam_age_sex_meanfd.rds` 与 `ABCD_PLOTDATASUM_RDS`（ratio 缩放与 LMM 一致）
     - 说明：默认比较 `SC.1_h`，可用 `EDGE_NAME=SC.X_h` 覆盖；随机斜率采用 `ranef(lmm)[["subID"]][["age"]]` 对齐后与 `lcmm$predRE$age` 比较，并输出个人斜率（固定+随机）的相关、最大差值。
     - 输出：`outputs/results/5th_cognition/abcd/age_lmm/tmp_lcmm_lmm_compare/`
   - ABCD cognition（uncorrected；within-person change × cognition）：
       - 入口脚本：`development_script/5th_cognition/run_abcd_withinperson_lmm_cognition_fluid_uncorrected.R`
       - sbatch（容器版，40 核）：`sbatch sbatch/run_abcd_withinperson_lmm_cognition_fluid_uncorrected_container.sbatch`
       - 结果：`outputs/results/5th_cognition/abcd/withinperson_lmm/`
       - 图像：`outputs/figures/5th_cognition/abcd/withinperson_lmm/`
         - 总强度：`delta_totalstrength_vs_nihtbx_fluidcomp_uncorrected_base_residualized.*`
         - S-A deciles（10 张图）：`delta_SC_decile{01..10}_vs_nihtbx_fluidcomp_uncorrected_base_residualized.*`（y 为“归一化连接强度比率”的变化率；log 中输出每张图的 r/p）
         - t value 散点：`scatter_tvalue_vs_SCrank_lmm_nihtbx_fluidcomp_uncorrected_base_CV75.*`
       - 输入：纵向 SC 使用 `*combatgam_age_sex_meanfd.rds`；baseline cognition 从 `*combatgam_cognition.rds` 提取后按 `subID` 合并到纵向 SC（保持“baseline 填充”设定）。
     - ABCD p-factor（GENERAL；within-person change × pfactor）：
       - 入口脚本：`development_script/6th_pfactor/run_abcd_withinperson_lmm_pfactor_general.R`
       - sbatch（容器版，40 核）：`sbatch sbatch/run_abcd_withinperson_lmm_pfactor_general_container.sbatch`
       - 结果：`outputs/results/6th_pfactor/abcd/withinperson_lmm/`
       - 图像：`outputs/figures/6th_pfactor/abcd/withinperson_lmm/`
         - `totalstrength` 预测（low10/high90）：`pred_totalstrength_time_by_GENERAL_low10_high90.*`
         - S-A deciles（汇总 1 张图）：`delta_SC_deciles_vs_pfactor_GENERAL_residualized.*`（y 为“归一化连接强度比率”的变化率；log 中输出每个 decile 的 r/p，并写入 `delta_SC_deciles_vs_pfactor_GENERAL_residualized_rp.csv`）
         - t value 散点：`scatter_tvalue_vs_SCrank_lmm_pfactor_GENERAL_CV75.*`
     - 可复现参数（两者通用，sbatch 通过环境变量传入）：
       - `N_EDGES=78`：拟合边数（调试时可设为 3–5）
       - `PB_METHOD=KR`（默认）或 `PB_METHOD=PB`：交互项检验方法
       - `PB_NSIM=1000`：仅对 `PB_METHOD=PB` 生效
   - ABCD latent change（change score）分析（两时间点，被试内变化率；线性模型）：
     - change score 定义：每条边的 `delta_SC/year = (SC_followup - SC_baseline)/(time_followup - time_baseline)`。
     - SC 归一化：每条连接先除以 `plotdatasum` 初始 `fit`，得到“归一化连接强度比率”，再计算 change score。
     - 模型：`change score ~ X + age_baseline + sex + mean_fd`
       - `X`：cognition（uncorrected；baseline 值）或 pfactor（baseline 值）
       - `age_baseline`：基线年龄（由 `eventname` 识别 baseline）
       - `mean_fd`：被试两次扫描的平均值
     - cognition 入口脚本：`development_script/5th_cognition/run_abcd_change_score_lm_cognition_uncorrected.R`
       - 输入：纵向 SC `*combatgam_age_sex_meanfd.rds`；baseline cognition 来自 `*combatgam_cognition.rds` 并按 `subID` 合并
       - 结果：`outputs/results/5th_cognition/abcd/change_score_lm/`
       - 统计：输出每条边 `beta_int`（X 的系数）与 FDR，并计算 `beta_int` 与 S-A rank 的相关
       - 图像：位于 `outputs/figures/5th_cognition/abcd/change_score_lm/`：`scatter_beta_vs_SCrank_change_score_*`、`scatter_tvalue_vs_SCrank_change_score_*` 与 `delta_SC_deciles_vs_*`（含 r/p CSV）
     - pfactor 入口脚本：`development_script/6th_pfactor/run_abcd_change_score_lm_pfactor_general.R`
       - 输入：纵向 SC `*combatgam_pfactor.rds`（含 pfactor）
       - 结果：`outputs/results/6th_pfactor/abcd/change_score_lm/`
       - 统计：输出每条边 `beta_int` 与 FDR，并计算 `beta_int` 与 S-A rank 的相关
       - 图像：位于 `outputs/figures/6th_pfactor/abcd/change_score_lm/`：`scatter_beta_vs_SCrank_change_score_*`、`scatter_tvalue_vs_SCrank_change_score_*` 与 `delta_SC_deciles_vs_*`（含 r/p CSV）
     - 相关输出：`SCrankcorr_change_score_*`（RDS；Spearman r/p）
	   - ABCD fluid cognition（uncorrected；Nonlinear-ComBat-GAM 输出 `*combatgam_cognition.rds`）可复现入口（原始设定：控制 `age(smooth)+sex+mean_fd`）：
	     - sbatch（容器版，72 核）：`sbatch sbatch/run_abcd_cognition_fluid_uncorrected_container.sbatch`
	     - 结果：`outputs/results/5th_cognition/abcd/cognition/`
	     - 图像：`outputs/figures/5th_cognition/abcd/cognition/`
	     - 注：sbatch 会依次运行 `run_abcd_cognition_fluid_uncorrected_S{1,2,3}.R`；其中 S3 需要 `ABCD_SA12_CSV` 与 `ABCD_PLOTDATASUM_RDS`（见下）。
	   - ABCD fluid cognition（age-corrected，baseline-only；Nonlinear-ComBat-GAM 变体 `*combatgam_comp_agecorrected_baseline.rds`）可复现入口：
	     - sbatch（容器版，72 核）：`sbatch sbatch/run_abcd_cognition_comp_agecorrected_container.sbatch`
	     - 结果：`outputs/results/5th_cognition/abcd/comp_agecorrected/`
	     - 图像（tiff+pdf）：`outputs/figures/5th_cognition/abcd/comp_agecorrected/`
	     - 注：为避免 `pandoc` 依赖，复现入口使用 `Rscript`（不走 `rmarkdown::render`）。
	     - 协变量设定（可选）：
	       - `COG_ASSOC_MODE=original`（默认）：控制 `s(age,k=3)+sex+mean_fd`
	       - `COG_ASSOC_MODE=sex_meanfd`：控制 `sex+mean_fd`（不含 `s(age, ...)`；适用于 age-corrected cognition 未校正性别的情况）
	       - `COG_ASSOC_MODE=meanfd_only`：仅控制 `mean_fd`（不含 `s(age, ...)`，不含 `sex`）
	     - 输出命名：默认不使用 tag（即覆盖式输出 16 张标准图与对应 rds）。如需并行保留多个变体，可用 `COG_ASSOC_TAG=<tag>` 作为文件名后缀（写成 `..._comp_agecorrected_<tag>.*`）。若未设置 tag 且 `COG_ASSOC_MODE!=original`，将自动使用 `_<mode>` 后缀以避免覆盖默认版本（例如 `_meanfd_only`、`_sex_meanfd`）。
	     - `sex_meanfd` 一键提交（容器版）：`sbatch sbatch/run_abcd_cognition_comp_agecorrected_sex_meanfd_container.sbatch`
	     - 注：sbatch 会依次运行 `run_abcd_cognition_comp_agecorrected_S{1,2,3}.R`；其中 S3 会在 `Cogvar/Interaction/` 下输出 `developmentcurve_decile*` 图像，并复用 `COG_ASSOC_TAG`/`COG_ASSOC_MODE` 后缀避免覆盖。
	     - 欧氏距离控制项默认读取：`wd/interdataFolder_ABCD/average_EuclideanDistance_12.csv`（可用 `ABCD_EUCLID_CSV` 覆盖）。
	     - 并行：脚本使用 `mclapply`（fork）并默认最多使用 60 个 worker（sbatch 仍可申请 72 CPU）；若遇到 `Cannot fork` 会按 60→50→40→30→20→… 自动降档直到可运行。

	   - ABCD fluid cognition（fully-corrected/fc，baseline-only；Nonlinear-ComBat-GAM 变体 `*combatgam_fluidcomp_fc_baseline.rds`）可复现入口：
	     - sbatch（容器版，72 核）：`sbatch sbatch/run_abcd_cognition_fluid_fc_container.sbatch`
	     - 结果：`outputs/results/5th_cognition/abcd/fluid_fc/`
	     - 图像（tiff+pdf）：`outputs/figures/5th_cognition/abcd/fluid_fc/`
	     - 协变量设定：同 age-corrected 入口，支持 `COG_ASSOC_MODE={original,sex_meanfd,meanfd_only}` 与 `COG_ASSOC_TAG`。

	   - S3（development curve）额外依赖：
	     - `ABCD_SA12_CSV`：默认 `wd/interdataFolder_ABCD/SA12_10.csv`
	     - `ABCD_PLOTDATASUM_RDS`：默认 `outputs/intermediate/2nd_fitdevelopmentalmodel/abcd/combat_gam/CV75/plotdatasum.df_SA12_sumSCinvnode_siteall_CV75.rds`（如需用其他版本，请在提交时覆盖该环境变量）
	     - S3 会在**纵向** SC 数据上拟合 `age × baseline cognition`（`gamm4` 需要每个 `subID` 至少两次观测；baseline-only 会失败）。
	       - uncorrected：优先从输入 SCdata 自身按 baseline `eventname` 提取；若纵向 SCdata 缺少 `nihtbx_fluidcomp_uncorrected`，则从 `demopath/DemodfScreenFinal.csv` 回填 baseline cognition；
	       - age-corrected：纵向 SCdata 通常不包含 `nihtbx_fluidcomp_agecorrected`，因此从 `demopath/DemodfScreenFinal.csv`（git-ignored）按 `subID` 回填 baseline cognition 后再拟合。
	       - fully-corrected/fc：纵向 SCdata 通常不包含 `nihtbx_fluidcomp_fc`，因此从 `demopath/DemodfScreenFinal.csv` 按 `subID` 回填 baseline cognition 后再拟合。

## CBCL 关联运行
- 默认使用容器镜像：`outputs/containers/scdevelopment_r41.sif`（可用 `SIF_PATH=/.../scdevelopment_r41_<tag>.sif` 指向新构建镜像）。
- CBCL 关联分析默认输入（ABCD Nonlinear-ComBat-GAM 输出）：`outputs/results/combat_gam/abcd/SCdata_SA12_CV75_sumSCinvnode.sum.msmtcsd.combatgam_cbcl.rds`。
- 全量作业脚本（容器版）：`sbatch/run_cbcl_assoc_full.sbatch`（使用 `outputs/containers/scdevelopment_r41.sif`；可用 `SIF_PATH` 指向新构建镜像）。
- 运行前确认 `outputs/logs/` 存在，脚本内会自动创建。
- 若需非容器运行，建议参考 `docs/workflow.md` 中关于 R ABI 隔离的说明，避免作业环境误加载用户库（`/GPFS/.../R/packages`）导致 ABI 不一致报错。

## 待补充说明
- 根据 `docs/research/Comments.pdf` 与 `docs/research/Manurscript_20251112.pdf` 更新 harmonize/ComBat 的描述与使用场景。
- 明确 CBCL total raw 与 SC 相关分析的输入表结构与协变量设置（与 p-factor 保持一致，ComBat 使用 `gamfunction/combat.R`）。

## 常见报错与处理
- `lme4` 载入失败（GLIBC 版本不匹配，指向 `GPFS/.../R/packages/lme4`）：sbatch 环境优先加载用户库导致；在脚本内清空 `R_LIBS_USER`/`R_LIBS` 并显式设置 `.libPaths()` 到 conda 环境库。
- `gratia`/`psych` 载入失败（GLIBC 版本不匹配）：优先确保作业激活 conda 环境并避免用户库路径污染。
- `cli.so`/`farver.so`/`Rcpp.so` 报 `GLIBC_2.xx not found`（HCP-D 发育模型、以及依赖 tidyverse 的脚本中较常见）：通常是 **登录节点与计算节点的 GLIBC 版本不一致**，导致在登录节点安装/更新过的 R 包（即使位于 conda 环境目录）在计算节点无法加载。
  - 处理：将 `R_LIBS_USER` 指向项目内的 R 库目录（例如 `outputs/r_libs/scdevelopment_r41/`），并在 sbatch 中对缺失/载入失败的包执行 `install.packages(..., lib=R_LIBS_USER)`，使其在计算节点上编译安装以匹配该节点的 GLIBC；同时保留 `R_LIBS_SITE=${CONDA_PREFIX}/lib/R/library` 作为回退路径。
  - 现有实现：`sbatch/run_hcpd_devmodel_combatgam_CV75.sbatch` 在运行前会自动创建并使用 `outputs/r_libs/scdevelopment_r41/`，并在“屏蔽系统/用户库”条件下检查与补装依赖。
- `install.packages()` 报 `cannot open URL .../PACKAGES` 或误报 “package is not available for this version of R”（HCP-D 发育模型中曾频繁出现）：通常是 **计算节点无法访问 CRAN**（网络策略/HTTPS 受限），导致无法拉取索引文件。
  - 处理：在登录节点预先构建离线 CRAN 源码仓库（`outputs/r_cran_repo/src/contrib/` + `PACKAGES.gz`），sbatch 在计算节点只从本地 repo 安装依赖（`options(repos=c(CRAN="file://.../outputs/r_cran_repo"))`），无需外网。
  - 现有实现：`sbatch/run_hcpd_devmodel_combatgam_CV75.sbatch` 会检查 `outputs/r_cran_repo/src/contrib/PACKAGES.gz` 是否存在；若存在则用离线 repo 安装缺失/载入失败的包到 `outputs/r_libs/scdevelopment_r41/`。
- HCP-D 发育模型容器作业报 `Error in match.names(clabs, names(xi)) : names do not match previous names`（`do.call -> rbind`）：通常是某些边级模型拟合失败导致返回对象列名不一致，直接 `rbind` 合并会崩溃。
  - 处理：对边级拟合使用 `tryCatch` 并跳过失败边；合并时用 `dplyr::bind_rows()`；将失败边标签写入 `failed_edges_*.txt` 便于追踪与复跑。
- HCP-D 发育模型容器作业在保存图片时报 `Error in Ops.data.frame(guide_loc, panel_loc) : '==' only defined for equally-sized data frames`（`ggsave -> add_guides`）：
  - 常见触发：容器内 `ggplot2`/`patchwork` 版本组合不稳定（特别是 `ggplot2 4.x`）。
  - 处理：使用已固定到稳定版本的容器重新构建镜像（当前定义中 `ggplot2==3.5.2`、`patchwork==1.3.0`），然后用 `SIF_PATH=/.../scdevelopment_r41_<tag>.sif sbatch sbatch/run_hcpd_devmodel_combatgam_CV75_container.sbatch` 指向新镜像执行。
- ABCD cognition（`gamfunction/gamcog.R`）在并行/集群环境下报 `object 'nbinom2' not found`（来自 `ecostats::anovaPB`）：
  - 原因：`anovaPB` 内部并行或对象序列化在某些节点上不稳定。
  - 处理：在 `gamfunction/gamcog.R` 中强制 `anovaPB(..., ncpus=1)` 并对失败回退为 `NA`（后续按 `p=1` 处理），避免全边失败。
- HCP-D 发育模型容器作业在 S3（可视化）报 `Error in plotdatasum[[i]][, -14] : incorrect number of dimensions` 且伴随 `all scheduled cores encountered errors`：常见于 **上游 S1 跳过部分边导致 `gammodelsum`/`gamresults` 不再满 78 条**，但 S3 仍按固定 `elementnum` 遍历并用固定列号删列。
  - 处理：S3 改为按可用边数迭代（`min(length(gammodelsum), nrow(gamresults))`），对 `plotdata_generate()` 增加 `tryCatch`；删列按响应列名（与 `parcel` 同名）删除，避免依赖固定列位置。
- `plotdatasum_scale_TRUE_SA12.rds` 中出现 `try-error` 且报 `lm object does not have a proper 'qr' component`：通常是 `plotdata_generate()` 内部 `predict(..., se.fit=TRUE)` 在少数模型上失败导致。
  - 处理：`gamfunction/plotdata_generate.R` 对 `se.fit=TRUE` 增加容错，失败时回退到 `se.fit=FALSE`（仅保留 `fit`，CI 列为 NA），确保后续流程可继续运行。
- `ggsave()` 报 `The package "svglite" is required to save as SVG`：当前环境/容器未安装 `svglite`。
  - 处理：HCP-D 的 S3/S4 脚本默认不再输出 `.svg`，改为输出无需额外依赖的 `.pdf`（同时保留 `.tiff`）。
- `gratia` 报 `there is no package called 'mvnfast'`：这是 `gratia` 的依赖缺失；若仅运行 CBCL 关联分析，已移除 `gamfunction/gamminteraction.R` 对 `gratia` 的依赖以避免该类问题。
- `tidyverse` 报 `readr/forcats/lubridate` 缺失：在 `scdevelopment` 环境安装 `r-tidyverse`（或补装 `r-readr`、`r-forcats`）。
- CBCL ComBat 输出中 `age` 列为嵌套 data.frame：在 CBCL 关联脚本中从 `demopath/DemodfScreenFinal.csv` 按 `scanID` 回填 `age`。
- `gratia` 需与 `ggplot2`/`mgcv` 版本匹配：R 4.1.x 下使用 `gratia_0.8.1`（CRAN Archive）以兼容 `mgcv 1.8`。
- `dplyr`/`rlang` 报 `undefined symbol: R_existsVarInFrame`：通常是 `R_LIBS_USER` 指向旧用户库（如 `/GPFS/.../R/packages`）导致 ABI 不一致；运行前显式设置 `R_LIBS_USER`/`R_LIBS` 到当前 conda 环境库路径，并用 `.libPaths()` 置顶该路径。
  - 注：`sbatch/run_cbcl_assoc_{smalltest,full}.sbatch` 已内置该隔离设置。

## 可复用经验（本次会话）
- **环境隔离**：为复现旧版脚本，建议新建独立 conda 环境（如 `scdevelopment_r41`，R 4.1.3），避免在旧环境上补装导致依赖漂移；必要时用 CRAN Archive 固定包版本（例如 `gratia_0.8.1`）。
- **sbatch 入参约定**：若脚本要求输出路径（如 Chinese ComBat），sbatch 模板应显式传参并将日志写到 `outputs/logs/`，避免默认 `slurm-*.out` 分散且误判为“无日志”。  
- **R ABI 报错排查**：出现 `rlang.so undefined symbol`、`GLIBC` 不匹配等问题时，优先排查作业是否误加载用户库（如 `/GPFS/.../R/packages`）；在 sbatch 内用 `Rscript --vanilla` 并显式设置 `R_LIBS_USER` 到 conda 库可显著降低此类问题。
- **并行与线程**：脚本并行尽量从 `SLURM_CPUS_PER_TASK` 读取核数（如 `mclapply`/`nlongcombat`）；同时限制 `OPENBLAS_NUM_THREADS/OMP_NUM_THREADS/MKL_NUM_THREADS=1` 避免线程过订阅导致性能下降或报错。
- **先隔离再诊断**：计算节点/登录节点差异（GLIBC、CRAN 访问）会把“包缺失/不可用”伪装为各种运行时错误；优先确保作业屏蔽 `R_LIBS_USER/R_LIBS` 并固定 `.libPaths()`，再判断是真缺包还是 ABI/网络问题。
- **容器优先补齐系统依赖**：`nloptr/lme4/gamm4/ragg/textshaping` 等失败常源于系统库缺失（如 `cmake/libwebp-dev/harfbuzz/freetype`），应优先写入 `containers/*.def`，比反复补装 R 包更稳定可复现。
- **版本固定优于“装最新版”**：R 4.1.x 下 CRAN 当前包常提高 R 版本门槛或发生 API 漂移（如 `gamm4`、`xfun/knitr`）；对关键链条使用 CRAN Archive 固定版本可显著降低构建/运行波动。
- **避免嵌套并行**：外层 `mclapply` 已并行时，`ecostats::anovaPB()` 等内部并行应显式收敛到单核（如 `ncpus=1`），避免序列化/worker 环境不一致导致的随机失败。
- **边级结果合并要容错**：边级拟合/预测一旦出现失败对象，`do.call(rbind, ...)` 容易整体崩溃；推荐 `tryCatch` 捕获失败并输出失败边清单，同时用 `dplyr::bind_rows()` 合并。
- **按标签对齐而非按序号**：下游步骤（S3/S4）不要假设永远有 78 条边且顺序固定；对 `SCrank`、欧氏距离、meanSC 等应按 `parcel` 映射对齐以兼容“部分缺失/跳过”的情况。
- **预测显式使用 mgcv 方法**：绘图预测应显式调用 `mgcv::predict.gam()`，并确保 `newdata` 的 factor level 与拟合数据一致；`se.fit=TRUE` 路径不稳定时提供回退（仅输出 `fit`、CI 为 NA）。
- **输出格式减少额外依赖**：`ggsave(.svg)` 依赖 `svglite`，在 HPC/容器环境中常缺；默认采用 `tiff + pdf` 更稳，降低系统依赖与编译链风险。
- **默认“存在即跳过”，保留强制重跑**：按步骤检测输出文件存在即可从失败点续跑并节省计算资源；同时提供 `--force=1` 便于单步重跑。
- **把排错固化为 QC**：用 conda 环境直接读取 RDS 做一致性与 `predict.gam` 可用性检查，可快速区分“模型问题”与“下游计算/绘图问题”，并输出可追踪的 QC 报告供复跑与比较。
- **neuroHarmonize 平滑项**：若通过 `smoothCon(... )$X` 手动构造基函数并作为线性协变量输入，`fx` 的影响通常不会体现在 `X` 上；要让固定/惩罚平滑生效，应使用 neuroHarmonize 原生 `smooth_terms`（`smooth_fx`）。
- **statsmodels spline 约束**：使用 `harmonizationLearn(..., smooth_terms=...)` 时，`smooth_df` 需满足 `smooth_df >= smooth_degree + 1`（例如三次样条 `degree=3` 时 `df>=4`）。
- **方差分解图耗时**：绘图阶段会对每条边重复拟合多次模型（Raw/ComBat × 多个 covariate 集合），通常远慢于一次性 ComBat；序列（sequential）R² 相比全子集方法更可控，且可通过并行显著缩短总耗时。
- **方差分解图解读**：`facet_grid(..., scales=\"free_y\")` 会放大 ComBat 面板的视觉高度；判断校正效果应结合数值计算（如导出 `siteID` 的 mean/max），避免仅凭堆叠柱形高度下结论。
- **数据/结果不入库**：`demopath/`、`outputs/`、`wd/`、`containers/` 等数据目录应在 `.gitignore` 忽略；若已被追踪，需要 `git rm -r --cached` 从索引移除（不删除磁盘文件）。
