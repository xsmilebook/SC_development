# Progress

- 2026-01-16: 更新 AGENTS.md 规则为中文并调整文档语言要求；建立会话记录与进度文件。
- 2026-01-16: 新增 `docs/README.md`、`docs/workflow.md`、`docs/methods.md`；更新 `README.md` 文档入口与 AGENTS 路径约定。
- 2026-01-16: 根据 `docs/research` 文档补充 `docs/methods.md` 的样本、影像与方法学摘要。
- 2026-01-16: 调整 `ARCHITECTURE.md` 与 `docs/workflow.md` 以匹配当前项目结构与开发需求。
- 2026-01-16: 更新 `AGENTS.md` 约定与 `ARCHITECTURE.md`/`docs/workflow.md` 的数据目录规则（新增 `data/`、`outputs/`）。
- 2026-01-16: 新增 `docs/combat_plan.md`，规划 ComBat/ComBat-GAM 实现与协变量配置。
- 2026-01-16: 更新 `docs/combat_plan.md`：ABCD 协变量修正、合并纵向校正说明与 GAMM 设定对齐。
- 2026-01-16: 更新 `docs/combat_plan.md`：确认沿用既有数据与 GAMM 调用位置一致。
- 2026-01-16: 更新 `docs/combat_plan.md`：ABCD 协变量加入 meanFD，并预留数据路径清单。
- 2026-01-16: 更新 `docs/combat_plan.md`：补齐 HCP-D、ABCD 与 Chinese Cohort 的集群路径。
- 2026-01-16: 更新 `docs/combat_plan.md`：补充 ComBat 使用的 SC 数据与协变量表路径。
- 2026-01-16: 更新 `docs/combat_plan.md`：明确 ABCD 认知方案仅使用基线数据。
- 2026-01-16: 更新 `AGENTS.md`：限制未经指示不得写入项目路径外文件。
- 2026-01-16: 新增 `combat_gam/` 并引入 neuroHarmonize 代码与纵向 ComBat 脚本集合。
- 2026-01-16: 更新 `AGENTS.md`：新增“修改代码或产生新结果需补充文档说明”的流程要求。
- 2026-01-16: 更新 `AGENTS.md`：区分小型任务与正式任务的执行方式（脚本直跑 vs sbatch/q_fat_c）。
- 2026-01-16: 更新 `PLAN.md`：测试直跑，正式任务使用 `sbatch`（`q_fat_c`）。
- 2026-01-17: 新增 ComBat-GAM 实现脚本与 sbatch 模板，完成 HCP-D/Chinese/ABCD 小样本测试。
- 2026-01-18: 建立 `scdevelopment` 环境并通过 rpy2 + mgcv 基函数实现 HCP-D/Chinese ComBat-GAM；更新脚本与文档并重跑小样本测试。
- 2026-01-18: 更新环境使用约定与工作流说明（依赖集中在 `scdevelopment`，冲突时新建环境）。
- 2026-01-18: 新增集群使用说明并移除 sbatch 模板中的 `--time`/`--mem` 设置。
- 2026-01-18: 为 ABCD Nonlinear-ComBat-GAM 增加并行执行支持，并更新集群与流程文档说明。
- 2026-01-18: 删除根目录下未使用的 `neuroCombat.R` 与 `nonlinearlongcombat.R`。
- 2026-01-18: 修复并行版 `nlongcombat` 的 batch 变量作用域错误（sbatch 报错：`Xe` 未定义）。
- 2026-01-18: 为 ABCD 并行提交设置 BLAS 线程限制以避免 OpenBLAS 线程创建失败。
- 2026-01-18: 生成 ABCD Raw vs ComBat 的结构连接 R2 方差分解图。
- 2026-01-18: 按参考图风格重绘 ABCD Raw vs ComBat 方差分解图。
- 2026-01-18: 修复 ComBat 面板柱数异常（edge 名称统一去除 `_h`）。
- 2026-01-18: 修正 Nonlinear-ComBat-GAM 的 batch 回加项（使用全部 batch dummy 列）。
- 2026-01-18: 生成 ABCD 三套协变量方案的 R2 方差分解图。
- 2026-01-18: 生成 HCPD 与 Chinese Cohort 的 Raw vs ComBat R2 方差分解图。
- 2026-01-18: 补充会话小结与关键经验记录。
- 2026-01-18: 合并 CBCL total raw 到 ABCD demopath，新增 CBCL（combat.R）与关联分析脚本，并更新流程与方法文档。
- 2026-01-18: 对齐 CBCL ComBat 脚本结构以匹配 `S3rd_combat_controlsite_ABCD.R`。
- 2026-01-18: 将 `demopath/` 与 `outputs/` 加入忽略清单，并纳入 `docs/` 到版本控制。
- 2026-01-18: CBCL ComBat 脚本加入小样本测试参数并移除 tidyverse 依赖。
- 2026-01-18: CBCL ComBat 脚本改用 `grepl` 以移除 `stringr` 依赖。
- 2026-01-18: CBCL ComBat 脚本在运行前合并 `cbcl_scr_syn_totprob_r` 到 SC 数据。
- 2026-01-18: CBCL ComBat 脚本的测试模式适配少量边时的 QC 变量选择。
- 2026-01-18: 重装 scdevelopment 环境中的 lme4 以解决 Matrix ABI 不匹配，并完成 CBCL ComBat 小样本测试。
- 2026-01-18: CBCL ComBat 脚本清空 `R_LIBS_USER`/`R_LIBS` 以避免用户库 GLIBC 冲突。
- 2026-01-18: CBCL ComBat 脚本显式设置 `.libPaths()` 指向 conda 环境库以避免加载用户 lme4。
- 2026-01-18: 在 scdevelopment 环境中安装 `R.matlab` 以修复 sbatch 中包缺失问题。
- 2026-01-18: 在 scdevelopment 环境中安装 `R.methodsS3`、`R.oo` 与 `R.utils` 以满足 `R.matlab` 依赖。
- 2026-01-18: 在 scdevelopment 环境中安装 `psych` 以修复 sbatch 中包缺失问题。
- 2026-01-18: 在 scdevelopment 环境中安装 `mnormt` 并通过强制 conda 库的小样本测试。
- 2026-01-18: 移除 CBCL ComBat 脚本对 `psych`/`R.matlab` 的依赖，避免 `mnormt` 的 GLIBC 冲突。
- 2026-01-18: 新增 CBCL Raw vs ComBat 方差分解绘图脚本并记录输出位置。
- 2026-01-18: 生成 CBCL Raw vs ComBat 方差分解图（png/pdf）。
- 2026-01-18: 评估 CBCL Raw vs ComBat 的 siteID R² 贡献（Raw 均值约 0.059，ComBat 均值约 0.00039）。
- 2026-01-18: 重新生成 CBCL 方差分解图并增加固定 y 轴版本以便比较。
- 2026-01-18: 更新 AGENTS/workflow 规则，要求新生成数据与结果保存在项目路径内。
- 2026-01-18: CBCL ComBat 输出路径调整到项目内 `outputs/results/combat_cbcl/`。
- 2026-01-18: 重新生成 CBCL Raw vs ComBat 方差分解图并替换旧版本。
- 2026-01-18: 导出 CBCL siteID R² 明细/汇总，并在固定 y 轴图中标注均值与最大值。
- 2026-01-18: 修复 CBCL 方差分解绘图脚本的 ComBat 数据列选择错误（避免旧 SC 原始列干扰标注）。
- 2026-01-18: 新增 CBCL 关联分析的 R 脚本版本并更新工作流引用。
- 2026-01-18: CBCL 关联分析脚本移除 tidyverse 依赖并加入小样本测试参数。
- 2026-01-18: CBCL 关联分析脚本小样本测试模式改为单核并跳过 S-A 相关步骤。
- 2026-01-18: CBCL 关联分析脚本测试模式关闭 bootstrap/pboot 以避免 PBrefdist 报错。
- 2026-01-18: 记录并修复 `lme4` GLIBC 报错（脚本内固定 conda R 库路径）。
- 2026-01-18: 移除 `gratia` 依赖，改用 `mgcv::predict()` 以规避 `nanonext` GLIBC 问题。
- 2026-01-18: 移除 `psych` 依赖，改用 `stats::cor`/`stats::cor.test` 以规避 `mnormt` GLIBC 问题。
- 2026-01-19: 回退 CBCL 关联分析脚本与 `gamfunction` 相关函数到历史版本以对齐原始实现。
- 2026-01-19: 新增 CBCL 关联分析容器定义与 sbatch 构建/运行脚本，并提供小样本验证脚本。
- 2026-01-19: 更新 `docs/workflow.md` 记录容器运行流程与对应脚本入口。
- 2026-01-19: 容器改为 conda R 4.1.x 构建以对齐原始开发版本。
- 2026-01-19: 放弃容器方案，改为本地 conda 环境运行并更新 sbatch 脚本。
- 2026-01-19: 修复 CBCL 关联脚本的 `age` 列异常（回填 demopath），并调整小样本测试以跳过 SCrankcorr。
- 2026-01-19: 更新 .gitignore，补充忽略 `wd/` 与 `containers/` 等存储数据目录。
- 2026-01-19: 新建 conda 环境 `scdevelopment_r41`（R 4.1.3）并切换 sbatch 使用新环境。
- 2026-01-19: 从 Git 暂存区移除 `wd/` 与 `demopath/` 目录下的历史数据文件。
- 2026-01-19: 使用 Chinese Cohort 新版 merge 数据重绘 ComBat 方差分解图。
- 2026-01-19: 保留 Chinese Cohort 新版 ComBat 结果并提交更新脚本。
- 2026-01-19: Chinese Cohort ComBat sbatch 脚本补充多分区提交顺序。
- 2026-01-19: 为 HCPD/Chinese 方差分解图增加每个协变量的 mean/max 标注以便核对。
- 2026-01-19: Chinese ComBat 与绘图脚本支持 new/old 双版本参数化运行。
- 2026-01-19: 删除 Chinese Cohort old 版本 ComBat 与图像，仅保留 new 作为最终版本。
- 2026-01-19: 更新 workflow 的可复用经验与常见报错说明。
- 2026-01-19: 修复 CBCL 关联分析 sbatch 的 `rlang` ABI 报错：移除脚本对 `tidyverse/stringr` 依赖，并在 sbatch 中隔离 `R_LIBS_USER` 指向 conda 环境库。
- 2026-01-19: 修复 CBCL 关联分析对 `gratia` 的依赖：`gamfunction/gamminteraction.R` 改用 `mgcv::predict()` 生成拟合与置信区间，避免缺失 `mvnfast` 触发的启动失败。
- 2026-01-19: CBCL total raw 关联分析脚本改为直接生成项目内绘图输出（t-value matrix、S-A rank 散点、5 组 S-A 分位数组轨迹），并删除不再使用的 `S2nd_cbcl_totalraw_effect_continuous_ABCD.Rmd`。
- 2026-01-19: CBCL 绘图输出风格对齐 p-factor（theme/字号/透明背景/`tiff+svg`），并将图统一写入 `outputs/figures/cbcl_totprob/`。
- 2026-01-19: CBCL 轨迹图按 S-A decile 1–10 输出（与 p-factor decile 绘图逻辑一致）。
- 2026-01-20: HCP-D/Chinese ComBat-GAM（neuroHarmonize）年龄平滑基函数改为 `fx=TRUE`（`s(age, k=3, bs="tp", fx=TRUE)`），与既定 GAMM 设定对齐。
- 2026-01-20: 方差分解图的变量解释量从 Shapley R² 改为序列（sequential）R²（按 `age→sex→mean_fd→表型→site` 逐步加入变量，计算增量 R²），并更新 ABCD/HCP-D/Chinese（及 CBCL）相关脚本与输出图。
- 2026-01-20: Chinese Cohort 方差分解绘图脚本默认 raw 输入切换为 `merge_new.rds`。
- 2026-01-20: 新增 HCP-D/Chinese 的 neuroHarmonize 原生 smooth_terms 提交脚本（Python）与 sbatch，用于对比 `smooth_fx` 的影响。
- 2026-01-20: ABCD 方差分解绘图脚本改用 `mgcv::gamm` 拟合纵向数据（random intercept=`subID`）计算 drop-one Delta R²。
- 2026-01-20: 新增 ABCD baseline `age+sex+meanFD` 纵向 ComBat（不保护 cognition）脚本与 sbatch：`combat_gam/scripts/run_abcd_nonlinear_combat_gam_baseline_age_sex_meanfd.R`、`combat_gam/sbatch/abcd_combat_gam_baseline_age_sex_meanfd.sbatch`。
- 2026-01-20: 统一 sbatch 使用多分区 `q_fat_c,q_fat,q_fat_l`；ABCD/HCPD/Chinese 的方差分解绘图 sbatch 提升到 72 核以加速 mclapply。
- 2026-01-20: 方差分解绘图更新为序列（sequential）R²，按 `age→sex→mean_fd→表型→site` 顺序计算变量解释量；ABCD 采用 `gamm4` 拟合纵向数据并对拟合失败的边执行跳过策略。
- 2026-01-20: 修复 ABCD 方差分解绘图在 baseline-only 或缺乏重复测量时 `gamm4` random intercept 不可用导致的崩溃：自动回退到 `mgcv::gam` 并对空结果安全退出。
- 2026-01-20: 补充 `docs/workflow.md` 的可复用经验：R ABI 隔离、并行/BLAS 线程、neuroHarmonize 平滑项与 statsmodels spline 约束、以及绘图耗时的定量解释。
