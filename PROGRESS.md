# Progress

- 2026-01-16: 更新 AGENTS.md 规则为中文并调整文档语言要求；建立会话记录与进度文件。
- 2026-01-16: 新增 `docs/README.md`、`docs/workflow.md`、`docs/methods.md`；更新 `README.md` 文档入口与 AGENTS 路径约定。
- 2026-01-16: 根据 `docs/research` 文档补充 `docs/methods.md` 的样本、影像与方法学摘要。
- 2026-01-16: 调整 `ARCHITECTURE.md` 与 `docs/workflow.md` 以匹配当前项目结构与开发需求。
- 2026-01-16: 更新 `AGENTS.md` 约定与 `ARCHITECTURE.md`/`docs/workflow.md` 的数据目录规则（新增 `data/`、`outputs/`）。
- 2026-01-16: 新增 `docs/combat_plan.md`，规划 ComBat/ComBat-GAM 实现与协变量配置。
- 2026-01-16: 更新 `docs/combat_plan.md`：ABCD 协变量修正、合并纵向校正说明与 GAMM 设定对齐。
- 2026-01-16: 更新 `docs/combat_plan.md`：确认沿用既有数据与 GAMM 调用位置一致。
- 2026-01-16: 更新 `docs/combat_plan.md`：ABCD 协变量加入 meanFD，并预留数据路径清单。
- 2026-01-16: 更新 `docs/combat_plan.md`：补齐 HCP-D、ABCD 与 Chinese Cohort 的集群路径。
- 2026-01-16: 更新 `docs/combat_plan.md`：补充 ComBat 使用的 SC 数据与协变量表路径。
- 2026-01-16: 更新 `docs/combat_plan.md`：明确 ABCD 认知方案仅使用基线数据。
- 2026-01-16: 更新 `AGENTS.md`：限制未经指示不得写入项目路径外文件。
- 2026-01-16: 新增 `combat_gam/` 并引入 neuroHarmonize 代码与纵向 ComBat 脚本集合。
- 2026-01-16: 更新 `AGENTS.md`：新增“修改代码或产生新结果需补充文档说明”的流程要求。
- 2026-01-16: 更新 `AGENTS.md`：区分小型任务与正式任务的执行方式（脚本直跑 vs sbatch/q_fat_c）。
- 2026-01-16: 更新 `PLAN.md`：测试直跑，正式任务使用 `sbatch`（`q_fat_c`）。
- 2026-01-17: 新增 ComBat-GAM 实现脚本与 sbatch 模板，完成 HCP-D/Chinese/ABCD 小样本测试。
- 2026-01-18: 建立 `scdevelopment` 环境并通过 rpy2 + mgcv 基函数实现 HCP-D/Chinese ComBat-GAM；更新脚本与文档并重跑小样本测试。
- 2026-01-18: 更新环境使用约定与工作流说明（依赖集中在 `scdevelopment`，冲突时新建环境）。
- 2026-01-18: 新增集群使用说明并移除 sbatch 模板中的 `--time`/`--mem` 设置。
- 2026-01-18: 为 ABCD Nonlinear-ComBat-GAM 增加并行执行支持，并更新集群与流程文档说明。
- 2026-01-18: 删除根目录下未使用的 `neuroCombat.R` 与 `nonlinearlongcombat.R`。
- 2026-01-18: 修复并行版 `nlongcombat` 的 batch 变量作用域错误（sbatch 报错：`Xe` 未定义）。
- 2026-01-18: 为 ABCD 并行提交设置 BLAS 线程限制以避免 OpenBLAS 线程创建失败。
- 2026-01-18: 生成 ABCD Raw vs ComBat 的结构连接 R2 方差分解图。
- 2026-01-18: 按参考图风格重绘 ABCD Raw vs ComBat 方差分解图。
- 2026-01-18: 修复 ComBat 面板柱数异常（edge 名称统一去除 `_h`）。
- 2026-01-18: 修正 Nonlinear-ComBat-GAM 的 batch 回加项（使用全部 batch dummy 列）。
- 2026-01-18: 生成 ABCD 三套协变量方案的 R2 方差分解图。
- 2026-01-18: 生成 HCPD 与 Chinese Cohort 的 Raw vs ComBat R2 方差分解图。
- 2026-01-18: 补充会话小结与关键经验记录。
- 2026-01-18: 合并 CBCL total raw 到 ABCD demopath，新增 CBCL（combat.R）与关联分析脚本，并更新流程与方法文档。
- 2026-01-18: 对齐 CBCL ComBat 脚本结构以匹配 `S3rd_combat_controlsite_ABCD.R`。
- 2026-01-18: 将 `demopath/` 与 `outputs/` 加入忽略清单，并纳入 `docs/` 到版本控制。
- 2026-01-18: CBCL ComBat 脚本加入小样本测试参数并移除 tidyverse 依赖。
- 2026-01-18: CBCL ComBat 脚本改用 `grepl` 以移除 `stringr` 依赖。
- 2026-01-18: CBCL ComBat 脚本在运行前合并 `cbcl_scr_syn_totprob_r` 到 SC 数据。
- 2026-01-18: CBCL ComBat 脚本的测试模式适配少量边时的 QC 变量选择。
- 2026-01-18: 重装 scdevelopment 环境中的 lme4 以解决 Matrix ABI 不匹配，并完成 CBCL ComBat 小样本测试。
- 2026-01-18: CBCL ComBat 脚本清空 `R_LIBS_USER`/`R_LIBS` 以避免用户库 GLIBC 冲突。
- 2026-01-18: CBCL ComBat 脚本显式设置 `.libPaths()` 指向 conda 环境库以避免加载用户 lme4。
- 2026-01-18: 在 scdevelopment 环境中安装 `R.matlab` 以修复 sbatch 中包缺失问题。
- 2026-01-18: 在 scdevelopment 环境中安装 `R.methodsS3`、`R.oo` 与 `R.utils` 以满足 `R.matlab` 依赖。
- 2026-01-18: 在 scdevelopment 环境中安装 `psych` 以修复 sbatch 中包缺失问题。
- 2026-01-18: 在 scdevelopment 环境中安装 `mnormt` 并通过强制 conda 库的小样本测试。
- 2026-01-18: 移除 CBCL ComBat 脚本对 `psych`/`R.matlab` 的依赖，避免 `mnormt` 的 GLIBC 冲突。
- 2026-01-18: 新增 CBCL Raw vs ComBat 方差分解绘图脚本并记录输出位置。
- 2026-01-18: 生成 CBCL Raw vs ComBat 方差分解图（png/pdf）。
- 2026-01-18: 评估 CBCL Raw vs ComBat 的 siteID R² 贡献（Raw 均值约 0.059，ComBat 均值约 0.00039）。
- 2026-01-18: 重新生成 CBCL 方差分解图并增加固定 y 轴版本以便比较。
- 2026-01-18: 更新 AGENTS/workflow 规则，要求新生成数据与结果保存在项目路径内。
- 2026-01-18: CBCL ComBat 输出路径调整到项目内 `outputs/results/combat_cbcl/`。
- 2026-01-18: 重新生成 CBCL Raw vs ComBat 方差分解图并替换旧版本。
- 2026-01-18: 导出 CBCL siteID R² 明细/汇总，并在固定 y 轴图中标注均值与最大值。
- 2026-01-18: 修复 CBCL 方差分解绘图脚本的 ComBat 数据列选择错误（避免旧 SC 原始列干扰标注）。
- 2026-01-18: 新增 CBCL 关联分析的 R 脚本版本并更新工作流引用。
- 2026-01-18: CBCL 关联分析脚本移除 tidyverse 依赖并加入小样本测试参数。
- 2026-01-18: CBCL 关联分析脚本小样本测试模式改为单核并跳过 S-A 相关步骤。
- 2026-01-18: CBCL 关联分析脚本测试模式关闭 bootstrap/pboot 以避免 PBrefdist 报错。
- 2026-01-18: 记录并修复 `lme4` GLIBC 报错（脚本内固定 conda R 库路径）。
- 2026-01-18: 移除 `gratia` 依赖，改用 `mgcv::predict()` 以规避 `nanonext` GLIBC 问题。
- 2026-01-18: 移除 `psych` 依赖，改用 `stats::cor`/`stats::cor.test` 以规避 `mnormt` GLIBC 问题。
- 2026-01-19: 回退 CBCL 关联分析脚本与 `gamfunction` 相关函数到历史版本以对齐原始实现。
- 2026-01-19: 新增 CBCL 关联分析容器定义与 sbatch 构建/运行脚本，并提供小样本验证脚本。
- 2026-01-19: 更新 `docs/workflow.md` 记录容器运行流程与对应脚本入口。
- 2026-01-19: 容器改为 conda R 4.1.x 构建以对齐原始开发版本。
- 2026-01-19: 放弃容器方案，改为本地 conda 环境运行并更新 sbatch 脚本。
- 2026-01-19: 修复 CBCL 关联脚本的 `age` 列异常（回填 demopath），并调整小样本测试以跳过 SCrankcorr。
- 2026-01-19: 更新 .gitignore，补充忽略 `wd/` 与 `containers/` 等存储数据目录。
- 2026-01-19: 新建 conda 环境 `scdevelopment_r41`（R 4.1.3）并切换 sbatch 使用新环境。
- 2026-01-19: 从 Git 暂存区移除 `wd/` 与 `demopath/` 目录下的历史数据文件。
- 2026-01-19: 使用 Chinese Cohort 新版 merge 数据重绘 ComBat 方差分解图。
- 2026-01-19: 保留 Chinese Cohort 新版 ComBat 结果并提交更新脚本。
- 2026-01-19: Chinese Cohort ComBat sbatch 脚本补充多分区提交顺序。
- 2026-01-19: 为 HCPD/Chinese 方差分解图增加每个协变量的 mean/max 标注以便核对。
- 2026-01-19: Chinese ComBat 与绘图脚本支持 new/old 双版本参数化运行。
- 2026-01-19: 删除 Chinese Cohort old 版本 ComBat 与图像，仅保留 new 作为最终版本。
- 2026-01-19: 更新 workflow 的可复用经验与常见报错说明。
- 2026-01-19: 修复 CBCL 关联分析 sbatch 的 `rlang` ABI 报错：移除脚本对 `tidyverse/stringr` 依赖，并在 sbatch 中隔离 `R_LIBS_USER` 指向 conda 环境库。
- 2026-01-19: 修复 CBCL 关联分析对 `gratia` 的依赖：`gamfunction/gamminteraction.R` 改用 `mgcv::predict()` 生成拟合与置信区间，避免缺失 `mvnfast` 触发的启动失败。
- 2026-01-19: CBCL total raw 关联分析脚本改为直接生成项目内绘图输出（t-value matrix、S-A rank 散点、5 组 S-A 分位数组轨迹），并删除不再使用的 `S2nd_cbcl_totalraw_effect_continuous_ABCD.Rmd`。
- 2026-01-19: CBCL 绘图输出风格对齐 p-factor（theme/字号/透明背景/`tiff+svg`），并将图统一写入 `outputs/figures/cbcl_totprob/`。
- 2026-01-19: CBCL 轨迹图按 S-A decile 1–10 输出（与 p-factor decile 绘图逻辑一致）。
- 2026-01-20: HCP-D/Chinese ComBat-GAM（neuroHarmonize）年龄平滑基函数改为 `fx=TRUE`（`s(age, k=3, bs="tp", fx=TRUE)`），与既定 GAMM 设定对齐。
- 2026-01-20: 方差分解图的变量解释量从 Shapley R² 改为序列（sequential）R²（按 `age→sex→mean_fd→表型→site` 逐步加入变量，计算增量 R²），并更新 ABCD/HCP-D/Chinese（及 CBCL）相关脚本与输出图。
- 2026-01-20: Chinese Cohort 方差分解绘图脚本默认 raw 输入切换为 `merge_new.rds`。
- 2026-01-20: 新增 HCP-D/Chinese 的 neuroHarmonize 原生 smooth_terms 提交脚本（Python）与 sbatch，用于对比 `smooth_fx` 的影响。
- 2026-01-20: ABCD 方差分解绘图脚本改用 `mgcv::gamm` 拟合纵向数据（random intercept=`subID`）计算 drop-one Delta R²。
- 2026-01-20: 新增 ABCD baseline `age+sex+meanFD` 纵向 ComBat（不保护 cognition）脚本与 sbatch：`combat_gam/scripts/run_abcd_nonlinear_combat_gam_baseline_age_sex_meanfd.R`、`combat_gam/sbatch/abcd_combat_gam_baseline_age_sex_meanfd.sbatch`。
- 2026-01-20: 统一 sbatch 使用多分区 `q_fat_c,q_fat,q_fat_l`；ABCD/HCPD/Chinese 的方差分解绘图 sbatch 提升到 72 核以加速 mclapply。
- 2026-01-20: 方差分解绘图更新为序列（sequential）R²，按 `age→sex→mean_fd→表型→site` 顺序计算变量解释量；ABCD 采用 `gamm4` 拟合纵向数据并对拟合失败的边执行跳过策略。
- 2026-01-20: 修复 ABCD 方差分解绘图在 baseline-only 或缺乏重复测量时 `gamm4` random intercept 不可用导致的崩溃：自动回退到 `mgcv::gam` 并对空结果安全退出。
- 2026-01-20: 补充 `docs/workflow.md` 的可复用经验：R ABI 隔离、并行/BLAS 线程、neuroHarmonize 平滑项与 statsmodels spline 约束、以及绘图耗时的定量解释。
- 2026-01-20: 基于 HCP-D ComBat-GAM 输出新增/修订发育模型脚本的可复现运行方式：HCP-D 的 S1/S2 脚本改为项目内路径；为 S3/S4 的 Rmd 增加对应 Rscript 版本；新增 sbatch `sbatch/run_hcpd_devmodel_combatgam_CV75.sbatch` 并统一产物写入 `outputs/`。
- 2026-01-20: 修复 HCP-D 发育模型 sbatch 因 R 包缺失导致的失败：补装 `gratia` 相关依赖（`mvnfast`）、`patchwork`、`ecostats`；sbatch 运行前增加“屏蔽系统库”条件下的依赖检查与 `.libPaths()` 打印。
- 2026-01-20: 修复 HCP-D 发育模型 S1 GAM 拟合失败：`gamfunction/gamsmooth.R`/`gamfunction/gamderivatives.R` 兼容 `gratia` 不同版本的导数输出列名；保留 `ecostats::anovaPB()` 但强制 `ncpus=1` 以避免并行序列化报错（如 `nbinom2 not found`）。
- 2026-01-20: 修复 HCP-D 发育模型在计算节点频繁出现的 `GLIBC_2.xx not found`（`cli.so`/`farver.so`/`Rcpp.so`）：sbatch 改为使用项目内 `outputs/r_libs/scdevelopment_r41/` 作为 `R_LIBS_USER`，在计算节点上自动编译补装缺失/载入失败的 R 依赖以匹配节点 GLIBC。
- 2026-01-20: 修复 HCP-D 发育模型在计算节点无法访问 CRAN 导致的依赖补装失败（`cannot open URL .../PACKAGES` / 误报 “package is not available”）：在项目内建立离线 CRAN 源码仓库 `outputs/r_cran_repo/`，sbatch 仅从本地 repo 安装依赖到 `outputs/r_libs/scdevelopment_r41/`。
- 2026-01-20: 新增项目专用 Singularity 容器（R 4.1.3）以避免计算节点 GLIBC/联网差异导致的 R 包加载与安装失败：提供定义文件 `containers/scdevelopment_r41.def`、构建脚本 `sbatch/build_scdevelopment_r41_container.sbatch` 与运行脚本 `sbatch/run_hcpd_devmodel_combatgam_CV75_container.sbatch`。
- 2026-01-20: 容器构建适配集群限制：移除 `singularity build --fakeroot`（避免 `/etc/subuid` 缺失导致失败），并在构建 sbatch 中加入计算节点代理环境变量导出以支持联网拉取依赖。
- 2026-01-20: 容器构建进一步适配集群权限限制：针对 “You must be the root user ... use --remote/--fakeroot” 报错，构建脚本切换为 `singularity build --remote` 并支持通过 `SINGULARITY_REMOTE_TOKEN` 非交互登录。
- 2026-01-20: 修复容器定义文件 `%post` 中 Rscript 多行转义导致的远端构建失败：改用 heredoc 写入临时 R 脚本后执行，避免 `unexpected end of line` 与 `build image size <= 0`。
- 2026-01-20: 修复容器内 `gamm4` 不可用：CRAN 当前版本要求 R>=4.4，容器改为安装 CRAN Archive `gamm4==0.2-6` 以兼容 R 4.1.3。
- 2026-01-20: 基于 `development_script/` 与 `gamfunction/` 的静态扫描扩展容器预装 R 包集合（如 `lme4`、`pbkrtest`、`reshape2`、`ggcorrplot`、`geomtextpath`、`paletteer`、`pals`、`visreg`、`gdata`、`rjson`、`tableone`、`knitr`），减少运行时缺包。
- 2026-01-20: 将容器依赖改为“最大稳定性”策略：对脚本依赖包及关键工具链包（如 `Rcpp/cli/farver/stringi/rlang/vctrs`、tidyverse 组件、绘图链条）使用 `remotes::install_version()` 显式固定版本，降低 CRAN 漂移风险。
- 2026-01-20: 修复容器构建时 R 包编译失败：为 `nloptr` 增加 `cmake`，为 `ragg` 增加 `libwebp-dev`；同时补齐并固定 `RcppEigen/minqa/nloptr` 以保证 `lme4/gamm4` 可编译安装。
- 2026-01-20: 简化容器 sbatch 的 module 加载逻辑：移除 Modules 初始化探测，直接使用 `module load singularity/3.7.0`。
- 2026-01-21: 修复容器构建中 `knitr` lazy-load 失败（`xfun` API 不匹配）：在 `containers/scdevelopment_r41.def` 中提前固定 `xfun==0.52`/`knitr==1.43` 并限制依赖安装范围，避免 CRAN 漂移导致的频繁构建失败；同步更新 `docs/workflow.md` 与会话记录说明。
- 2026-01-21: 容器构建脚本改为每次生成新 SIF（`scdevelopment_r41_<tag>.sif`），避免覆盖正在用于任务执行的旧镜像；容器运行脚本支持 `SIF_PATH` 选择镜像。
- 2026-01-21: 修复 HCP-D 发育模型容器作业的 `rbind` 崩溃（`names do not match previous names`）：S1 脚本对边级拟合加入 `tryCatch` 并跳过失败边，改用 `bind_rows` 合并并输出失败边清单；同步更新工作流与会话记录。
- 2026-01-21: 修复 HCP-D 发育模型容器作业 S3 可视化崩溃（`plotdatasum[[i]][, -14] : incorrect number of dimensions`）：S3 改为按可用边数迭代、对 `plotdata_generate()` 增加容错并按列名删除响应列；S4 的欧氏距离与均值强度改为按 `parcel` 映射对齐以兼容“部分边缺失”。
- 2026-01-21: 修复 `plotdata_generate()` 预测标准误失败导致的 `try-error`（`lm object does not have a proper 'qr' component`）：`predict(..., se.fit=TRUE)` 失败时回退到 `se.fit=FALSE`，保证 `plotdatasum_scale_TRUE_SA12.rds` 可用并避免绘图阶段崩溃。
- 2026-01-21: 加固 `plotdata_generate()`：强制使用 `mgcv::predict.gam()` 并对齐 newdata 的 factor level/类型，避免 `se.fit=TRUE` 路径触发 `qr` 相关错误导致的警告与失败。
- 2026-01-21: HCP-D 发育模型 S1-S4 默认改为“存在即跳过”（逐步跳过），并提供 `--force=1` 强制重跑开关，便于从失败步骤续跑并减少重复计算。
- 2026-01-21: 新增 conda 环境下的 HCP-D 发育模型输出 QC：检查 `gamresults/gammodel` 一致性与 `predict.gam` 可用性（屏蔽用户/系统 R 包路径），并输出 QC 报告到 `outputs/results/.../qc/`。
- 2026-01-21: 修复容器/环境缺少 `svglite` 导致 `.svg` 保存失败：HCP-D 发育模型 S3/S4 默认输出改为 `.pdf`（保留 `.tiff`）。
- 2026-01-21: 将本次容器/依赖/并行/容错/对齐/QC 等可复用经验整理补充到 `docs/workflow.md`，作为后续排错与复现的优先清单。
- 2026-01-30: 新增两时间点纵向 LMM（random intercept + random slope）交互模型函数 `gamfunction/lmminteraction.R`，并提供 ABCD cognition（baseline 填充）与 pfactor（time-varying）对应的复现入口脚本、容器 sbatch 与 within-person change 相关 figure；更新 `docs/workflow.md` 与会话记录。
- 2026-01-30: 更新 cognition 的 decile 级 change-score figure：使用归一化连接强度比率（按 `plotdatasum` 的初始 `fit` 缩放），并在 log 中输出每个 decile 图的 r/p。
- 2026-01-30: 新增 change score（latent change）线性模型：实现 `gamfunction/lmfunction.R`，并提供 cognition/pfactor 的 per-edge change-score LM 与 S-A rank 相关结果输出。
- 2026-01-30: change-score LM 补充 beta vs S-A rank 散点与 decile change-score 图，并提供对应 sbatch 容器脚本。
- 2026-01-30: 为 change-score LM 与 within-person LMM 添加 t value 的 S-A rank 散点与相关输出。
- 2026-01-30: 新增 age 线性混合模型（固定效应 + 随机斜率）与 baseline cognition 低/高 10% 分组矩阵输出（固定/随机）与 S-A 相关散点。
- 2026-01-22: 修复 ABCD cognition 关联分析绘图阶段 `theme()` 报错：避免 `mvabund::theme()` 覆盖 `ggplot2::theme()` 导致参数冲突。
- 2026-01-22: ABCD `nihtbx_fluidcomp_agecorrected` 关联分析新增 `meanfd_only` 变体（`COG_ASSOC_MODE=meanfd_only`），并提供独立 sbatch 脚本避免覆盖默认输出。
- 2026-01-23: pfactor/CBCL 的 `developmentcurve_decile*` 图像将 age 横坐标标签按 ×10 显示（0.9→9）；并为 ABCD cognition（uncorrected/age-corrected）新增 S3 development-curve 绘图脚本并接入 sbatch。
- 2026-01-23: 修复 ABCD cognition（age-corrected）S3 在 baseline-only 输入下 `gamm4` 全边失败：S3 改为读取纵向 SC 数据 `*combatgam_age_sex_meanfd.rds` 并从 `demopath/DemodfScreenFinal.csv` 回填 baseline cognition 后再拟合交互模型。
- 2026-01-23: cognition S3 baseline cognition 改为从 SCdata 自身提取；若 SCdata 缺失表型列则报错提示缺失列名（不再从 demopath 回填）。
- 2026-01-23: 对齐原始 S3：uncorrected 从纵向 SCdata 提取 baseline cognition；age-corrected 因纵向 SCdata 缺少 `nihtbx_fluidcomp_agecorrected`，改为从 `demopath/DemodfScreenFinal.csv` 回填 baseline cognition。
- 2026-01-23: 修复 age-corrected cognition S3 在纵向 SCdata 缺少 `eventname` 时的误报缺列：仅要求 `subID/age/sex/mean_fd`；baseline cognition 仍按需从 demopath 回填。
- 2026-01-23: cognition 脚本支持从 `scanID` 派生 `eventname`（`_ses-baselineYear1Arm1`→`baseline_year_1_arm_1`），用于 baseline 过滤与 baseline cognition 提取。
- 2026-01-23: 修复 cognition S3 读取旧版缓存（list of data.frame）时的 `subscript out of bounds`：兼容旧/新两种缓存结构。
- 2026-01-23: cognition S3 遇到“空/不可用缓存”时自动删除并重算（等价于 `FORCE=1`），避免反复报 `No plot data available after loading cache`。
- 2026-01-23: 修复 cognition uncorrected S3 在纵向 SCdata 缺少 `nihtbx_fluidcomp_uncorrected` 时的失败：允许从 `demopath/DemodfScreenFinal.csv` 回填 baseline cognition 后继续拟合。
- 2026-01-21: 修复 HCP-D 发育模型容器作业 S3 在 `derivative.df` 缺少 `significant.derivative_fdr` 列时的崩溃：S3 自动补齐该列（优先使用 `significance_pvalue_fdr`，否则用 `significant`/`significant.derivative` 回退）。
- 2026-01-21: 修复 HCP-D 发育模型容器作业 S4 在 `psych::corr.test()` 返回标量时的崩溃：散点图标题相关性提取兼容矩阵/标量两种返回结构，避免 `ct$r[[1,2]]` 下标错误。
- 2026-01-21: 加固容器 sbatch：当 S3 decile 图或 S4 相关性散点图缺失时，自动对对应步骤启用 `--force=1` 回填图片（支持 `FORCE_S3/FORCE_S4` 覆盖），避免 “哨兵/summary 存在但图片目录为空”。
- 2026-01-21: 修复 HCP-D 发育模型容器作业 S3 在保存图片时 ggplot guide 计算异常导致的崩溃（`add_guides` 下标比较错误）：对相关 scale 显式设置 `guide=\"none\"`，避免无图例场景进入 guide 布局分支。
- 2026-01-21: DemodfScreenFinal 增补 NIH Toolbox fluid cognition（age-corrected）列：将 `demopath/nc_y_nihtb.csv` 的 `nihtbx_fluidcomp_agecorrected` 合并到 `demopath/DemodfScreenFinal.csv`（按 `src_subject_id+eventname` 对齐）。
- 2026-01-21: 新增 ABCD 纵向 Nonlinear-ComBat-GAM 变体脚本与 sbatch：CBCL total problems（参考 pfactor，不做 baseline-only）与 NIH Toolbox total cognition age-corrected（参考 cognition，baseline-only）。
- 2026-01-21: 修复 ABCD Nonlinear-ComBat-GAM（CBCL/total cognition age-corrected）因输入 RDS 缺少表型列而失败：脚本检测到缺列时按 `scanID` 从 `demopath/DemodfScreenFinal.csv` 自动回填协变量并继续运行。
- 2026-01-21: 修复 HCP-D 发育模型容器作业保存图片时 `add_guides` 崩溃（`Ops.data.frame(guide_loc, panel_loc)`）：容器定义将 `ggplot2` 固定到 `3.5.2` 并将 `patchwork` 更新到 `1.3.0`（同时满足 `geomtextpath` 对 `ggplot2>=3.5.2` 的依赖），需重建新 SIF 并用 `SIF_PATH` 复跑。
- 2026-01-21: CBCL total raw 关联分析输入切换为 ABCD Nonlinear-ComBat-GAM 输出：`development_script/6th_pfactor/S2nd_cbcl_totalraw_effect_continuous_ABCD*.R` 默认读取 `outputs/results/combat_gam/abcd/*combatgam_cbcl.rds`（缺少 `handness/race_ethnicity` 时按 `scanID` 从 demopath 自动回填）。
- 2026-01-21: CBCL 全量关联作业脚本改为容器版：`sbatch/run_cbcl_assoc_full.sbatch` 使用 `outputs/containers/scdevelopment_r41.sif`；并删除 `sbatch/run_cbcl_assoc_smalltest.sbatch`。
- 2026-01-21: ABCD total cognition（age-corrected，baseline-only）复现入口：更新 `development_script/5th_cognition` 的 ABCD Rmd 以读取 `*combatgam_comp_agecorrected_baseline.rds` 并输出 tiff+pdf；新增容器 sbatch `sbatch/run_abcd_cognition_comp_agecorrected_container.sbatch`（72 核）渲染报告到 `outputs/reports/`。
- 2026-01-21: 由于容器缺少 `pandoc`，将上述复现入口从 `rmarkdown::render` 调整为纯 `Rscript`（新增 `run_abcd_cognition_comp_agecorrected_{S1,S2}.R`；sbatch 同步改为直接运行 Rscript），避免 `pandoc version 1.12.3+ required` 报错。
- 2026-01-21: 为避免计算节点进程数限制导致 `Cannot fork`，ABCD comp_agecorrected 复现脚本默认并行 worker 上限设为 60（作业仍申请 72 CPU），并在创建失败时按 60→50→40→30→20→… 逐步降档。
- 2026-01-21: 修复 ABCD cognition 并行运行中 `ecostats::anovaPB` 报 `object 'nbinom2' not found` 导致全边失败：`gamfunction/gamcog.R` 强制 `anovaPB(..., ncpus=1)` 并对失败回退为 `p=1`，保证流水线可运行。
- 2026-01-22: 排查并修复 ABCD cognition 旧列名引用：`development_script/5th_cognition/S2nd_compositescorePlot_scatterplot_ABCD.Rmd` 将 `gam.cog.t` 更新为 `gam.smooth.t`，与 `gamfunction/gamcog.R` 输出列保持一致。
- 2026-01-22: 回退 `combat_gam/sbatch/*.sbatch` 的容器化改动，恢复为 conda 环境提交（按需求不使用容器运行 ComBat-GAM/绘图作业）。
- 2026-01-22: 为规避计算节点 `GLIBC_2.32 not found` 导致的 `dplyr/cli` 加载失败，`combat_gam/sbatch/plot_*_variance_decomposition.sbatch` 默认改用 `CONDA_ENV=scdevelopment`（可覆盖）。
- 2026-01-22: ABCD cognition（age-corrected fluid cognition）新增的 SC–cognition 关联分析更新协变量：`development_script/5th_cognition/run_abcd_cognition_comp_agecorrected_{S1,S2}.R` 不再加入 `s(age, ...)` 且不再包含 `sex`，仅控制 `mean_fd`；`gamfunction/gamcog.R` 同步支持“无 smooth 项”的模型分支。
- 2026-01-22: 为避免覆盖历史输出，ABCD cognition（age-corrected）关联分析的结果与图片文件名加入 `COG_ASSOC_TAG` 后缀（默认 `meanfd_only`），并在 `docs/workflow.md` 中补充使用方式。
- 2026-01-22: 方差分解绘图脚本改为直接使用 `summary(fit$gam)$r.sq`（mgcv 的 R² 指标）提取 R²：`combat_gam/scripts/plot_abcd_variance_decomposition.R` 与 `combat_gam/scripts/plot_hcpd_chinese_variance_decomposition.R` 不再使用自定义 RSS/TSS 公式计算。
- 2026-01-22: 方差分解绘图在日志中增加每个变量的 R² 输出：对 Raw/ComBat 分别汇总每个 predictor 的顺序贡献（mean/median）与 total R²（mean/median），便于在 slurm log 直接核对。
- 2026-01-22: `combat_gam/scripts/plot_abcd_variance_decomposition.R` 扩展 ABCD 方差分解绘图：新增 CBCL total problems（`abcd_variance_decomp_cbcl_totprob`）与 fluid cognition age-corrected（`abcd_variance_decomp_cognition_fluidcomp_agecorrected`）两种变体，并在 Raw 输入缺少表型列时尝试从 `demopath/DemodfScreenFinal.csv` 按 `scanID` 回填。
- 2026-01-22: 为避免混淆，ABCD 方差分解绘图将 cognition 与 age-corrected cognition 输出前缀拆分为不同文件名：`abcd_variance_decomp_cognition_fluid_uncorrected` 与 `abcd_variance_decomp_cognition_fluidcomp_agecorrected`（原前缀不再使用）。
- 2026-01-22: 将 `demopath/nc_y_nihtb.csv` 的 `nihtbx_fluidcomp_agecorrected` 合并到 `demopath/DemodfScreenFinal.csv`（按 `src_subject_id+eventname` 对齐），用于后续按 `scanID` 回填表型列。
- 2026-01-22: 为满足“仅 16 张 figure”的输出规范，ABCD age-corrected cognition 图像默认不再生成 tag 版（`COG_ASSOC_TAG` 仅在需要保留多套变体时使用）。
- 2026-01-22: 新增 ABCD fluid cognition（uncorrected；`nihtbx_fluidcomp_uncorrected`）的 Rscript 复现入口：`development_script/5th_cognition/run_abcd_cognition_fluid_uncorrected_{S1,S2}.R` 读取 `outputs/results/combat_gam/abcd/*combatgam_cognition.rds`，按原始设定控制 `s(age)+sex+mean_fd` 并输出到 `outputs/results/5th_cognition/abcd/cognition/`；提供容器 sbatch：`sbatch/run_abcd_cognition_fluid_uncorrected_container.sbatch`。
- 2026-01-22: 新增 ABCD p-factor（GENERAL）连续效应 + age-by-pfactor smooth interaction 的 Rscript 复现入口：`development_script/6th_pfactor/run_abcd_pfactor_effect_continuous_S1.R` 读取 `outputs/results/combat_gam/abcd/*combatgam_pfactor.rds` 并输出到 `outputs/results/6th_pfactor/abcd/pfactor/`；提供容器 sbatch：`sbatch/run_abcd_pfactor_effect_continuous_container.sbatch`。
- 2026-01-22: p-factor S1 Rscript 补齐原始 Rmd 的图像输出：S-A rank scatter（tiff+svg/pdf）、12×12 matrix（tiff）与 decile 交互曲线（tiff+svg/pdf）；并在 sbatch 中加入 `/ibmgpfs` bind 与 `ABCD_PLOTDATASUM_RDS` 传递以支持交互曲线计算。
- 2026-01-22: ABCD age-corrected cognition 的 S2 绘图加固：当部分边拟合失败时，自动在邻近 SCrank 的候选边中寻找可用边并保证输出三张示例散点图（必要时写占位图），避免 “部分图像缺失”。
- 2026-01-23: 修复 pfactor 与 cognition S3 交互曲线年龄范围不足（9–11）：脚本对 age 单位做自动识别（年/月）并统一到“年”，避免重复 `/12` 缩放导致范围被压缩。
- 2026-01-23: pfactor 与 cognition S3 交互曲线在 log 中输出输入 SCdata 的 age 范围与 eventname 分布，便于确认是否因数据缺少 13 岁随访导致范围不足。
- 2026-01-23: 将 ABCD NIH Toolbox fluid cognition fully-corrected（`nihtbx_fluidcomp_fc`）回填进 `demopath/DemodfScreenFinal.csv`，并新增对应的 baseline-only Nonlinear-ComBat-GAM 变体与 cognition（S1/S2/S3）复现入口及容器 sbatch。
- 2026-01-23: ABCD 方差分解绘图脚本 `combat_gam/scripts/plot_abcd_variance_decomposition.R` 新增 fully-corrected/fc（`nihtbx_fluidcomp_fc`）的 Raw vs ComBat 输出：`abcd_variance_decomp_cognition_fluidcomp_fc`。
- 2026-01-23: 修复 `abcd_variance_decomp_cognition_fluidcomp_fc` 图中 `fluidcomp_fc` 图例缺失：为 `fluidcomp_fc` 补齐 palette 映射并设置 `drop=FALSE`，同时强制将 `nihtbx_fluidcomp_fc` 转为 numeric。
- 2026-01-23: 新增基于 ComBat-GAM 数据的年龄分辨 S-A 对齐分析：`development_script/4th_changerate_SAcorr/S1st_SAcorr_alongAge_{HCPD,ABCD}.R`，并提供对应容器 sbatch（生成图片且在日志输出 flip-age 与 rho 等关键数值）。
- 2026-01-23: 为 HCP-D 4th 分析补齐 flip-age 分组的 GAM 模型脚本（Rscript）并接入 `sbatch/run_hcpd_changerate_sacorr_combatgam_CV75_container.sbatch`，实现 S1+S2 完整流程输出。
- 2026-01-26: ABCD fluid cognition（age-corrected，baseline-only）新增协变量模式 `COG_ASSOC_MODE=sex_meanfd`（控制 `sex+mean_fd`，不含 `s(age)`）；并将一键提交脚本重命名为 `sbatch/run_abcd_cognition_comp_agecorrected_sex_meanfd_container.sbatch`。
- 2026-01-26: 容器定义补齐绘图依赖 `svglite`/`Cairo`，用于稳定生成 `svg/pdf/tiff` 输出；需重建 `scdevelopment_r41` 镜像后生效。
- 2026-01-26: 完善 ABCD ComBat-GAM 2nd 发育模型流程：补齐 S3/S4 Rscript、扩展 S1 产出 `plotdatasum.df_*` 与完整 stats，并新增容器 sbatch `sbatch/run_abcd_devmodel_combatgam_CV75_container.sbatch`。
- 2026-01-26: 修复 `gamfunction/gammsmooth.R` 中 gratia 导数输出列名变动导致的 `.lower_ci` 报错，兼容新旧列名格式。
- 2026-01-26: 修复 ABCD S3 图像生成时 `partialRsq`/`meanderv2` 非数值导致的 `abs()` 报错。
- 2026-01-26: 修复 ABCD S3 在 `partialRsq`/`meanderv2` 为空时的赋值错误（填充 NA 并按行扩展）。
- 2026-01-26: ABCD S1 自动检测 `gamresults` 缺列并强制重算，避免旧版最小输出导致后续为空。
- 2026-01-26: 修复 ABCD S4 控制欧氏距离残差时的长度不一致问题（NA 行回填）。
- 2026-01-26: 修复 ABCD S4 残差索引为非数字导致的赋值错误（直接使用 na.exclude 残差向量）。
- 2026-01-26: ABCD S1 增加“全边成功”硬检查，若任一边拟合失败则中止并写出失败边清单。
- 2026-01-26: ABCD plotdata 默认路径统一到项目内 `outputs/intermediate/2nd_fitdevelopmentalmodel/abcd/combat_gam/CV75/plotdatasum.df_SA12_sumSCinvnode_siteall_CV75.rds`，并更新 sbatch/脚本引用。
- 2026-01-27: 修复 ABCD p-factor 交互曲线年龄范围异常：`run_abcd_pfactor_effect_continuous_S1.R` 的 `age_to_years()` 兼容 `years/12`（疑似重复按月缩放）并回补到“年”。
- 2026-01-27: p-factor 交互曲线自动检测并刷新旧缓存（当缓存 age 范围明显不合理时强制重算），避免 `FORCE=0` 时继续复用错误年龄范围。
- 2026-01-27: 新增 Chinese Cohort（ComBat-GAM 输出）的 2nd 发育模型可复现流程：补齐 S1–S4 Rscript（GAM + 导数 + 可视化 + S-A 相关）并提供容器 sbatch `sbatch/run_chinese_devmodel_combatgam_CV75_container.sbatch`。
- 2026-01-27: Chinese devmodel 图像输出对齐原始 Rmd：S3 默认输出 3 张（tiff+pdf）；S4 默认输出 3 张（2×tiff + 1×pdf），并保留 matrix graph 的可选开关（避免依赖 `svglite`）。
- 2026-01-27: 新增 HCP-D（Yeo7/Yeo17/TractSeg major-bundle）ComBat-GAM 一键 sbatch：`combat_gam/sbatch/hcpd_combat_gam_yeo_tractseg_CV75.sbatch`，输出写入 `outputs/results/combat_gam/hcpd/`。
- 2026-01-27: 基于 `development_script/2nd_fitdevelopmentalmodel/V_Yeo_network` 与 `V_TractSeg` 补齐 HCP-D 的 Yeo7/Yeo17/TractSeg（ComBat-GAM 输出）发育模型可复现入口（S1–S4）并提供容器一键提交：`sbatch/run_hcpd_devmodel_combatgam_CV75_yeo_tractseg_container.sbatch`，图像命名与原脚本保持一致。
- 2026-01-27: 修复 HCP-D Yeo/TractSeg ComBat-GAM sbatch 读取外部 `.rds` 报错：`run_combat_gam_neuroharmonize.py` 在 `pyreadr` 失败时自动回退到 `rpy2 + readRDS()` 读取，以兼容新版本 RDS 序列化特性。
- 2026-01-27: HCP-D 派生表（Yeo/TractSeg）若缺少 `site` 列，ComBat-GAM 脚本支持从 SA12 merge 表按 `subID` 回填 `site`（`--batch-source-rds`），并已在 `combat_gam/sbatch/hcpd_combat_gam_yeo_tractseg_CV75.sbatch` 默认启用。
- 2026-01-27: 修复 HCP-D Yeo/TractSeg devmodel 容器作业缺少 `svglite` 导致 SVG 输出失败：相关脚本默认改为输出 `tiff+pdf`（不再依赖 `svglite`）。
- 2026-01-27: 修复 HCP-D Yeo/TractSeg devmodel 容器作业 OpenBLAS `pthread_create failed`：在 sbatch 中强制设置 `OPENBLAS_NUM_THREADS/OMP_NUM_THREADS/MKL_NUM_THREADS=1`（通过 `SINGULARITYENV_*` 传入容器）。
- 2026-01-27: 修复 Chinese devmodel 容器作业缺少 `svglite` 导致 SVG 输出失败：Chinese S3/S4 默认改为输出 `tiff+pdf`；对应 sbatch 默认改为 72 核，并设置 `SINGULARITYENV_*` 限制 BLAS/OMP 线程数。
- 2026-01-27: 新增 HCP-D（Yeo7/Yeo17/TractSeg）4th_changerate_SAcorr 可复现流程：实现年龄分辨对齐曲线（S1）与 flip-age 分组 GAM（S2）脚本，并提供容器一键提交 `sbatch/run_hcpd_changerate_sacorr_combatgam_CV75_yeo_tractseg_container.sbatch`；日志输出 `[RESULT]` 的关键数值，图像输出为 `tiff+pdf`。
- 2026-01-28: HCP-D（Yeo7/Yeo17/TractSeg，ComBat-GAM）与 Chinese Cohort（ComBat-GAM）发育模型 S4：即使 `SCrank_correlation_summary.csv` 已存在并跳过重算，也会在日志中打印各指标的 Spearman 相关系数与 p 值。
- 2026-01-28: 统一 ABCD 与 HCP-D 的 2nd 发育模型（SA12，ComBat-GAM）绘图风格：对齐到 HCP-D Yeo7 图像（尺寸、配色、主题与散点/线宽设置），以保持跨数据集的可比性。
- 2026-01-28: sbatch 提交流程默认强制重绘 S3/S4：在 HCP-D/ABCD 2nd devmodel 的 sbatch 中对 S3/S4 固定传入 `--force=1`，避免旧图残留并简化“补图”判断逻辑。
- 2026-01-28: 新增 HCP-D（SA12，ComBat-GAM）协变量敏感性分析（SES 与 ICV 两版本）入口：基于 `development_script/2nd_fitdevelopmentalmodel/V_Covariates` 脚本，输出统一为 `tiff+pdf`（不生成 svg），并在日志打印 S4 的 Spearman r/p；提供容器 sbatch 一键提交 `sbatch/run_hcpd_devmodel_combatgam_CV75_covariates_ses_icv_container.sbatch`。
- 2026-01-28: 新增 HCP-D（SA12）4th_changerate_SAcorr 的协变量敏感性分析（SES/ICV）容器 sbatch：基于 `development_script/4th_changerate_SAcorr/V_Covariates`，输出 `tiff+pdf` 并在日志中打印 flip-age 与 rho 等 `[RESULT]` 数值。
- 2026-01-28: 加固 HCP-D 协变量敏感性分析脚本：在 covariate 管线的 S2/S4 中若检测到输入数据缺少 `income.adj/ICV`（或为 NA），则从 `demopath/HCPD_demo_behav.csv` 按 `subID` 回填并写出 backfilled 版本到项目 `outputs/intermediate/`，同时在日志输出缺失计数。
- 2026-01-28: 修复 HCP-D covariates devmodel 容器作业 “All GAM fits failed / Not enough (non-NA) data”：S1 对 `subID` 做标准化（去除 `sub-` 前缀）后再从 `demopath/HCPD_demo_behav.csv` 回填 `income.adj/ICV`，并对 `age/sex/mean_fd/covariate` 做 complete-case 过滤与计数输出，避免回填不匹配导致全边失败。
- 2026-01-28: HCP-D（SA12，ComBat-GAM）changerate S-A 对齐分析：S1 增加 control-distance 版本（对 change rate 按欧氏距离残差化后再相关），并将主要对齐图/flip-age 分布图风格对齐 TractSeg（尺寸/配色/主题一致；默认不生成 svg）。
- 2026-01-28: 新增 Chinese Cohort（SA12，ComBat-GAM）4th_changerate_SAcorr 可复现入口：实现 S1 对齐曲线（含关键 `[RESULT]` 数值输出、默认不生成 svg、输出 `tiff+pdf`）与 S2 flip-age 分组 GAM（日志输出 r/p，输出 `tiff+pdf`），并提供容器 sbatch `sbatch/run_chinese_changerate_sacorr_combatgam_CV75_container.sbatch`。
- 2026-01-28: 新增 HCP-D SA7/SA17 ComBat-GAM sbatch 与对应 devmodel/changerate 容器入口；同时扩展 HCP-D devmodel/changerate 脚本支持 `--ds_res`、`--out_tag` 与 `--sa_axis_mode={addsquare,multiply}`，并统一默认输出 `tiff+pdf`、日志打印关键数值（r/p、flip-age、rho）。
- 2026-01-29: 修复 HCP-D SA7/SA17 devmodel 容器 sbatch 在 `EUCLID_CSV` 为空时因 `set -u` + 空数组展开导致的 `euclid_arg[@]: unbound variable` 报错，确保 S4 可正常生成 `correlation_sumSCinvnode_SCrank_*` 散点图。
- 2026-01-29: 将 HCP-D SA7/SA17/SA12 merge 输入与 Euclidean-distance 输入复制到 `data/external/SC_development/interdataFolder_HCPD/`（不纳入版本控制），并让 SA7/SA17 ComBat-GAM/devmodel sbatch 优先使用项目内副本以减少外部路径依赖。
- 2026-01-29: SA7/SA17 devmodel 不启用 control-distance（无需计算）；同时在 S4 增加健壮性：若 Euclidean-distance 覆盖不全则自动跳过，避免 SA17 中断导致缺图。
- 2026-01-29: 修复 HCP-D changerate S1 在 `do_control_distance=FALSE` 时仍汇总全 NA 的 control-distance 矩阵导致的报错，确保 SA7/SA17 changerate 可正常出图与输出数值。
- 2026-01-29: HCP-D devmodel S4：当 summary 已存在且 `--force=0` 时，若检测到 S4 的散点图缺失则仍继续生成 `correlation_sumSCinvnode_SCrank_*` 图像（SA7/SA17 等 tag 版本同样适用）。
- 2026-01-29: ABCD ComBat-GAM S4 散点图风格对齐参考脚本，并将输出调整为 `pdf`（必需）+ Windows 下 `svg`。
- 2026-01-29: ABCD ComBat-GAM S4 在 Windows 下默认跳过 summary 计算，仅生成散点图，并在缺少 `svglite` 时跳过 svg 输出。
- 2026-01-29: ABCD ComBat-GAM S4 散点图改为按 `SCrank` 着色，颜色随 S-A 轴单调变化。
- 2026-01-29: Chinese Cohort ComBat-GAM S4 散点图改为按 `SCrank` 着色，输出补齐 `pdf` 并在 Windows 下输出 `svg`，同时支持 Windows 下跳过 summary 计算。
- 2026-01-29: HCP-D S4 相关脚本（SA12/Yeo/TractSeg/Covariates/SAmult）散点图统一按 `SCrank` 着色并使用指定主题，输出补齐 `pdf` 且 Windows 下可输出 `svg`，支持 Windows 下跳过 summary 计算。
- 2026-01-29: HCP-D S4 相关图移除标题，并将 meanderv2 相关图纵轴统一为 `Second derivative`。
- 2026-01-29: 为避免 Windows 本地运行触发 RStudio Reconnect，HCP-D S4 脚本在 Windows 下默认仅绘图（不写 summary）。
- 2026-01-29: HCP-D S4 在 Windows 交互环境默认跳过 matrix graphs，并强制单核与非并行路径以提升稳定性。
- 2026-01-29: HCP-D S4 SA7/SA17 散点图 x 轴刻度与范围按分辨率设置，meanderv2 相关图统一 y 轴刻度。
- 2026-01-29: HCP-D S4 在 SA7/SA17 下固定散点颜色映射范围，确保色标两端一致。
- 2026-01-29: 修复 HCP-D S4 在 SA17 输入 SC 列数不匹配时的 setNames 报错，缺列时跳过 meanSC 相关性检查。
- 2026-01-29: SAmult 本地绘图脚本改为使用项目内输入/输出路径以对齐 sbatch。
- 2026-01-29: HCP-D TractSeg 与 covariates 的 S4 在 Windows 交互环境默认仅绘图并跳过 matrix graphs。
- 2026-01-29: HCP-D Yeo7/Yeo17 S4 在 Windows 交互环境默认仅绘图并跳过 matrix graphs，散点坐标与色标范围按分辨率固定。
- 2026-01-29: 修复 Yeo7/17 绘图中 `correlation.df` 未定义导致的报错。
- 2026-01-29: 修复 Yeo7/17 绘图色标范围依赖未初始化 `correlation.df` 的问题。
- 2026-01-29: 统一 4th_changerate_SAcorr 多数据集/验证分析脚本的绘图主题与输出格式，Windows 下默认仅绘图并追加 svg。
- 2026-01-29: 修复 HCP-D 4th changerate S1 在绘制导数折线图时缺失 `edge_sarank_value` 的报错。
- 2026-01-29: 修复 HCP-D Yeo7 S4 散点图因 color scale 限制导致丢点的问题。
- 2026-01-29: HCP-D Yeo7 S4 散点图保留离群点（不再将 meanderv2_2 异常值设为 NA）。
- 2026-02-02: 新增 ABCD 年龄随机斜率 LMM 的容器 sbatch（`sbatch/run_abcd_age_lmm_random_slope_cognition_groups_container.sbatch`），并将该脚本的矩阵与 S-A 相关散点图风格对齐旧版输出（点/线宽与配色一致）。
- 2026-02-02: age 随机斜率 LMM 的矩阵绘图加入 limthr 兜底，避免全 NA/全 0 时绘图为空。
- 2026-02-02: 新增 ABCD p-factor 分组的年龄随机斜率 LMM 脚本与容器 sbatch（输出矩阵与 S-A 相关散点对齐旧版样式）。
- 2026-02-02: 年龄随机斜率 LMM 的随机效应矩阵改为“平均绝对随机斜率”，避免随机效应均值≈0 导致矩阵全白。
- 2026-02-02: 年龄随机斜率 LMM 的矩阵色标改为旧版做法（lwth=最小值，limits=lwth到- lwth），并对正值矩阵强制对称范围。
- 2026-02-02: 年龄随机斜率 LMM 固定效应矩阵仅保留整体版本，不再绘制低/高 10% 固定效应矩阵。
- 2026-02-02: 修复 age LMM 矩阵图全白：矩阵显式设置 dimnames 为 1..12 并在 melt 后鲁棒转换坐标；同时禁止 N_EDGES<78 时向量回收填充导致矩阵异常。
- 2026-02-02: age LMM 脚本在 N_EDGES<78 的测试模式下为结果/图像文件追加 `_N<n_edges>` 后缀，避免小样本覆盖全量输出；并在日志提示灰色矩阵为预期。
- 2026-02-02: age LMM cognition 脚本支持本地直跑与参数化输入/输出路径（支持命令行参数与环境变量），可在非项目根目录执行。
- 2026-02-02: 删除 ABCD age LMM cognition/p-factor 分组脚本（对应文档入口同步移除）。
- 2026-02-02: 新增 age LMM cognition 分组脚本与 `gamfunction/lmm_age_random_slope.R`，实现 `(1 + age || subID)` 并输出 fixed/random 矩阵与 S-A 相关散点。
- 2026-02-02: age LMM 随机斜率接口对齐现有流程：移除异常值剔除与 tryCatch，保持与既有 cognition 脚本一致的筛选逻辑。
- 2026-02-02: age LMM 随机斜率接口移除 bobyqa 控制项并新增个体随机斜率返回选项（含固定斜率）。
- 2026-02-02: age LMM 随机斜率接口新增模型返回选项（`return_model=TRUE`）。
- 2026-02-02: age LMM cognition 脚本移除 low10/high10 分组拟合与矩阵输出，仅保留全样本结果。
- 2026-02-02: age LMM cognition 脚本保存每条边的 `lmer` 模型对象（便于检查拟合）。
- 2026-02-02: age LMM cognition 脚本建模前增加 ratio 缩放（复用 `plotdatasum` 的 `fit`）。
- 2026-02-02: age LMM ≥2 时间点筛选移到脚本层，函数仅做 complete-case。
- 2026-02-02: 新增临时脚本对比 lcmm 与 lmm 的随机效应差异（单边示例，沿用现有清洗与 ratio 缩放）。
- 2026-02-02: 临时脚本补充个人斜率（固定+随机）对比与按 subID 对齐逻辑。
- 2026-02-02: 临时脚本移除基于 `lmer@u` 的随机斜率比较，改为仅使用 `ranef(...)[[\"subID\"]][[\"age\"]]` 并按 subID/ID 对齐。
- 2026-02-02: age LMM 收敛检查阈值调整为 0.02 以减少轻微梯度警告。
