# Progress

- 2026-01-16: 更新 AGENTS.md 规则为中文并调整文档语言要求；建立会话记录与进度文件。
- 2026-01-16: 新增 `docs/README.md`、`docs/workflow.md`、`docs/methods.md`；更新 `README.md` 文档入口与 AGENTS 路径约定。
- 2026-01-16: 根据 `docs/research` 文档补充 `docs/methods.md` 的样本、影像与方法学摘要。
- 2026-01-16: 调整 `ARCHITECTURE.md` 与 `docs/workflow.md` 以匹配当前项目结构与开发需求。
- 2026-01-16: 更新 `AGENTS.md` 约定与 `ARCHITECTURE.md`/`docs/workflow.md` 的数据目录规则（新增 `data/`、`outputs/`）。
- 2026-01-16: 新增 `docs/combat_plan.md`，规划 ComBat/ComBat-GAM 实现与协变量配置。
- 2026-01-16: 更新 `docs/combat_plan.md`：ABCD 协变量修正、合并纵向校正说明与 GAMM 设定对齐。
- 2026-01-16: 更新 `docs/combat_plan.md`：确认沿用既有数据与 GAMM 调用位置一致。
- 2026-01-16: 更新 `docs/combat_plan.md`：ABCD 协变量加入 meanFD，并预留数据路径清单。
- 2026-01-16: 更新 `docs/combat_plan.md`：补齐 HCP-D、ABCD 与 Chinese Cohort 的集群路径。
- 2026-01-16: 更新 `docs/combat_plan.md`：补充 ComBat 使用的 SC 数据与协变量表路径。
- 2026-01-16: 更新 `docs/combat_plan.md`：明确 ABCD 认知方案仅使用基线数据。
- 2026-01-16: 更新 `AGENTS.md`：限制未经指示不得写入项目路径外文件。
- 2026-01-16: 新增 `combat_gam/` 并引入 neuroHarmonize 代码与纵向 ComBat 脚本集合。
- 2026-01-16: 更新 `AGENTS.md`：新增“修改代码或产生新结果需补充文档说明”的流程要求。
- 2026-01-16: 更新 `AGENTS.md`：区分小型任务与正式任务的执行方式（脚本直跑 vs sbatch/q_fat_c）。
- 2026-01-16: 更新 `PLAN.md`：测试直跑，正式任务使用 `sbatch`（`q_fat_c`）。
- 2026-01-17: 新增 ComBat-GAM 实现脚本与 sbatch 模板，完成 HCP-D/Chinese/ABCD 小样本测试。
- 2026-01-18: 建立 `scdevelopment` 环境并通过 rpy2 + mgcv 基函数实现 HCP-D/Chinese ComBat-GAM；更新脚本与文档并重跑小样本测试。
- 2026-01-18: 更新环境使用约定与工作流说明（依赖集中在 `scdevelopment`，冲突时新建环境）。
- 2026-01-18: 新增集群使用说明并移除 sbatch 模板中的 `--time`/`--mem` 设置。
- 2026-01-18: 为 ABCD Nonlinear-ComBat-GAM 增加并行执行支持，并更新集群与流程文档说明。
- 2026-01-18: 删除根目录下未使用的 `neuroCombat.R` 与 `nonlinearlongcombat.R`。
- 2026-01-18: 修复并行版 `nlongcombat` 的 batch 变量作用域错误（sbatch 报错：`Xe` 未定义）。
- 2026-01-18: 为 ABCD 并行提交设置 BLAS 线程限制以避免 OpenBLAS 线程创建失败。
- 2026-01-18: 生成 ABCD Raw vs ComBat 的结构连接 R2 方差分解图。
- 2026-01-18: 按参考图风格重绘 ABCD Raw vs ComBat 方差分解图。
- 2026-01-18: 修复 ComBat 面板柱数异常（edge 名称统一去除 `_h`）。
- 2026-01-18: 修正 Nonlinear-ComBat-GAM 的 batch 回加项（使用全部 batch dummy 列）。
- 2026-01-18: 生成 ABCD 三套协变量方案的 R2 方差分解图。
- 2026-01-18: 生成 HCPD 与 Chinese Cohort 的 Raw vs ComBat R2 方差分解图。
- 2026-01-18: 补充会话小结与关键经验记录。
- 2026-01-18: 合并 CBCL total raw 到 ABCD demopath，新增 CBCL（combat.R）与关联分析脚本，并更新流程与方法文档。
- 2026-01-18: 对齐 CBCL ComBat 脚本结构以匹配 `S3rd_combat_controlsite_ABCD.R`。
- 2026-01-18: 将 `demopath/` 与 `outputs/` 加入忽略清单，并纳入 `docs/` 到版本控制。
- 2026-01-18: CBCL ComBat 脚本加入小样本测试参数并移除 tidyverse 依赖。
- 2026-01-18: CBCL ComBat 脚本改用 `grepl` 以移除 `stringr` 依赖。
- 2026-01-18: CBCL ComBat 脚本在运行前合并 `cbcl_scr_syn_totprob_r` 到 SC 数据。
- 2026-01-18: CBCL ComBat 脚本的测试模式适配少量边时的 QC 变量选择。
- 2026-01-18: 重装 scdevelopment 环境中的 lme4 以解决 Matrix ABI 不匹配，并完成 CBCL ComBat 小样本测试。
- 2026-01-18: CBCL ComBat 脚本清空 `R_LIBS_USER`/`R_LIBS` 以避免用户库 GLIBC 冲突。
- 2026-01-18: CBCL ComBat 脚本显式设置 `.libPaths()` 指向 conda 环境库以避免加载用户 lme4。
- 2026-01-18: 在 scdevelopment 环境中安装 `R.matlab` 以修复 sbatch 中包缺失问题。
- 2026-01-18: 在 scdevelopment 环境中安装 `R.methodsS3`、`R.oo` 与 `R.utils` 以满足 `R.matlab` 依赖。
- 2026-01-18: 在 scdevelopment 环境中安装 `psych` 以修复 sbatch 中包缺失问题。
- 2026-01-18: 在 scdevelopment 环境中安装 `mnormt` 并通过强制 conda 库的小样本测试。
- 2026-01-18: 移除 CBCL ComBat 脚本对 `psych`/`R.matlab` 的依赖，避免 `mnormt` 的 GLIBC 冲突。
- 2026-01-18: 新增 CBCL Raw vs ComBat 方差分解绘图脚本并记录输出位置。
- 2026-01-18: 生成 CBCL Raw vs ComBat 方差分解图（png/pdf）。
- 2026-01-18: 评估 CBCL Raw vs ComBat 的 siteID R² 贡献（Raw 均值约 0.059，ComBat 均值约 0.00039）。
- 2026-01-18: 重新生成 CBCL 方差分解图并增加固定 y 轴版本以便比较。
- 2026-01-18: 更新 AGENTS/workflow 规则，要求新生成数据与结果保存在项目路径内。
- 2026-01-18: CBCL ComBat 输出路径调整到项目内 `outputs/results/combat_cbcl/`。
- 2026-01-18: 重新生成 CBCL Raw vs ComBat 方差分解图并替换旧版本。
- 2026-01-18: 导出 CBCL siteID R² 明细/汇总，并在固定 y 轴图中标注均值与最大值。
- 2026-01-18: 修复 CBCL 方差分解绘图脚本的 ComBat 数据列选择错误（避免旧 SC 原始列干扰标注）。
- 2026-01-18: 新增 CBCL 关联分析的 R 脚本版本并更新工作流引用。
- 2026-01-18: CBCL 关联分析脚本移除 tidyverse 依赖并加入小样本测试参数。
- 2026-01-18: CBCL 关联分析脚本小样本测试模式改为单核并跳过 S-A 相关步骤。
- 2026-01-18: CBCL 关联分析脚本测试模式关闭 bootstrap/pboot 以避免 PBrefdist 报错。
- 2026-01-18: 记录并修复 `lme4` GLIBC 报错（脚本内固定 conda R 库路径）。
- 2026-01-18: 移除 `gratia` 依赖，改用 `mgcv::predict()` 以规避 `nanonext` GLIBC 问题。
- 2026-01-18: 移除 `psych` 依赖，改用 `stats::cor`/`stats::cor.test` 以规避 `mnormt` GLIBC 问题。
- 2026-01-19: 回退 CBCL 关联分析脚本与 `gamfunction` 相关函数到历史版本以对齐原始实现。
- 2026-01-19: 新增 CBCL 关联分析容器定义与 sbatch 构建/运行脚本，并提供小样本验证脚本。
- 2026-01-19: 更新 `docs/workflow.md` 记录容器运行流程与对应脚本入口。
