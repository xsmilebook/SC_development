Bootstrap: docker
From: rocker/r-ver:4.1.3

%labels
    Project SCDevelopment
    R 4.1.3

%environment
    export LC_ALL=C
    export LANG=C
    export LANGUAGE=C

%post
    set -e

    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y --no-install-recommends \
        build-essential \
        ca-certificates \
        curl \
        git \
        gfortran \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        zlib1g-dev \
        libgsl-dev \
        libglpk40 \
        libharfbuzz-dev \
        libfribidi-dev \
        libfreetype6-dev \
        libpng-dev \
        libtiff5-dev \
        libjpeg-dev \
        libcairo2-dev \
        libfontconfig1-dev \
        libicu-dev \
        libxt-dev
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # Keep key versions aligned with the current conda-based workflow:
    # - R 4.1.3 (base image)
    # - mgcv 1.8-42
    # - nlme 3.1-162
    # - gratia 0.8.1 (compatible with R 4.1.x)
    # - ecostats 1.2.2 (anovaPB)
    #
    # Use a heredoc to avoid shell escaping issues inside `%post`.
    cat > /tmp/install_r_pkgs.R <<'RS'
    options(repos = c(CRAN = "https://cloud.r-project.org"))
    install.packages("remotes")
    library(remotes)

    pin <- function(pkg, ver) {
      install_version(pkg, version = ver, upgrade = "never")
    }

    # Base toolchain-ish packages to stabilize tidyverse compilation & loading
    # (versions aligned to the existing scdevelopment_r41 workflow).
    pin("Rcpp", "1.0.10")
    pin("cli", "3.6.1")
    pin("farver", "2.1.1")
    pin("stringi", "1.7.12")
    pin("rlang", "1.1.1")
    pin("vctrs", "0.6.2")

    # Core modeling stack
    pin("mgcv", "1.8-42")
    pin("nlme", "3.1-162")
    pin("ecostats", "1.2.2")
    pin("gratia", "0.8.1")
    pin("mvnfast", "0.2.8")

    # Tidyverse components (pin individually + meta package)
    pin("ggplot2", "4.0.1")
    pin("dplyr", "1.1.2")
    pin("tidyr", "1.3.0")
    pin("stringr", "1.5.0")
    pin("readr", "2.1.4")
    pin("purrr", "1.0.1")
    pin("tibble", "3.2.1")
    pin("forcats", "1.0.0")
    pin("tidyverse", "1.3.2")

    # Plot helpers used in scripts
    pin("scales", "1.4.0")
    pin("patchwork", "1.1.2")
    pin("corrplot", "0.95")
    pin("ggcorrplot", "0.1.4.1")
    pin("geomtextpath", "0.2.0")
    pin("paletteer", "1.7.0")
    pin("pals", "1.10")
    pin("visreg", "2.8.0")

    # IO / utilities used in scripts
    pin("openxlsx", "4.2.8.1")
    pin("matrixStats", "1.5.0")
    pin("gdata", "3.0.1")
    pin("rjson", "0.2.23")
    pin("reshape", "0.8.9")
    pin("reshape2", "1.4.5")
    pin("R.matlab", "3.7.0")
    pin("psych", "2.3.3")
    pin("knitr", "1.43")
    pin("tableone", "0.13.2")

    # Mixed models and related inference
    pin("lme4", "1.1-33")
    pin("pbkrtest", "0.5-2")

    # ragg stack (not required by every script, but often needed for reliable raster output)
    pin("systemfonts", "1.3.1")
    pin("textshaping", "1.0.4")
    pin("ragg", "1.5.0")

    # CRAN current gamm4 requires R >= 4.4; pin an archive version compatible with R 4.1.x.
    pin("gamm4", "0.2-6")
RS
    Rscript --vanilla /tmp/install_r_pkgs.R
    rm -f /tmp/install_r_pkgs.R

%runscript
    exec Rscript --vanilla "$@"
